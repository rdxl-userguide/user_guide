<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WEHAGO ì „ìê²°ì¬ í¼ ìƒì„±ê¸°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #5a67d8; --primary-hover: #4c51bf; --border-color: #e2e8f0;
            --background-light: #f7fafc; --background-white: #ffffff; --text-dark: #2d3748;
            --text-light: #718096; --success-color: #38a169;
        }
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        /* --- ë ˆì´ì•„ì›ƒ êµ¬ì¡° --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Pretendard', sans-serif; background-color: var(--background-light);
            margin: 0; padding: 2rem;
            box-sizing: border-box;
        }
        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 2rem;
        }
        .fixed-width-container {
            width: 100%;
            max-width: 900px;
        }
        .expandable-width-container {
            width: 100%;
            max-width: 900px; /* JSì— ì˜í•´ ë™ì ìœ¼ë¡œ ë³€ê²½ë¨ */
            transition: max-width 0.4s ease-in-out; /* ë„ˆë¹„ ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜ */
        }

        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        h1 { font-size: 2rem; color: var(--text-dark); text-align: center; margin-bottom: 2.5rem; }
        .section { background: var(--background-white); padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        h2 { font-size: 1.25rem; color: var(--text-dark); margin-top: 0; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .label-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        label { font-weight: 500; font-size: 0.875rem; color: var(--text-light); }
        .label-icons { display: flex; align-items: center; }
        input, select { width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; box-sizing: border-box; font-family: inherit; transition: all 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.15); }
        input::placeholder { color: #cbd5e0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }

        /* --- ë²„íŠ¼ & ì•„ì´ì½˜ --- */
        .button { display: inline-block; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; color: white; background-color: var(--primary-color); border: none; border-radius: 0.5rem; cursor: pointer; text-align: center; transition: background-color 0.2s; }
        .button:hover { background-color: var(--primary-hover); }
        .button-secondary { background-color: #edf2f7; color: var(--text-dark); }
        .button-secondary:hover { background-color: #e2e8f0; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0 0 0 0.5rem; line-height: 1; opacity: 0.3; transition: opacity 0.2s; }
        .icon-btn:hover { opacity: 1; }
        .hide-btn { font-size: 1.2rem; font-weight: bold; }

        /* --- ìˆ¨ê¹€/ë³µì› ê¸°ëŠ¥ --- */
        .restore-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border-color); }
        .restore-section h4 { margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-light); font-weight: 500; }
        .restore-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .restore-btn { background-color: #edf2f7; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.25rem 0.75rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .restore-btn:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* --- í•­ëª©(Item) ì¹´ë“œ --- */
        #items-container-wrapper { width: 100%; overflow-x: auto; margin-top: 1.5rem; }
        #items-container { display: flex; gap: 1.5rem; padding-bottom: 1rem; }
        .item-card { background-color: var(--background-light); border: 1px solid #e2e8f0; padding: 1.5rem; border-radius: 0.5rem; transition: opacity 0.3s, transform 0.3s; flex: 0 0 320px; }
        .item-card.single-item { flex: 1 1 auto; }
        .item-fields-container > div { margin-bottom: 1.25rem; }
        .item-fields-container > div:last-child { margin-bottom: 0; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .item-header h3 { margin: 0; font-size: 1.1rem; }
        .remove-item-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); line-height: 1; }

        /* --- UX ê°œì„  --- */
        #copyFeedback { text-align: center; color: var(--primary-color); font-weight: 600; margin-top: 1rem; opacity: 0; transition: opacity 0.5s; height: 24px;}
        .highlight { transition: box-shadow 0.1s; box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.4); }
        .header-controls { display:flex; justify-content:space-between; align-items:center; }

        /* --- ë²„ì „ ì •ë³´ --- */
        .version-info {
            text-align: center;
            margin-top: 3rem;
            color: var(--text-light);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="fixed-width-container">
        <h1>WEHAGO ì „ìê²°ì¬ í¼ ìƒì„±ê¸° ğŸ’¡</h1>
        <div class="section" style="margin-bottom: 2rem;">
            <div class="header-controls">
                <h2>0. ì–‘ì‹ ì¢…ë¥˜ ì„ íƒ</h2>
                <button id="reset-btn" class="button button-secondary" style="padding: 0.5rem 1rem;">[â†»] ìƒˆë¡œ ì‘ì„±</button>
            </div>
            <select id="masterFormType" class="button" style="width:100%; text-align:left; margin-top: 1rem;">
                <option value="general_expense">ì§€ì¶œí’ˆì˜ì„œ - ì¼ë°˜</option>
                <option value="meeting_expense">ì§€ì¶œí’ˆì˜ì„œ - ì‚¬ë‚´ ì‚¬ì™¸ íšŒì˜ë¹„</option>
                <option value="outsourcing_expense">ì§€ì¶œí’ˆì˜ì„œ - ì™¸ì£¼ìš©ì—­</option>
                <option value="education_expense">ì§€ì¶œí’ˆì˜ì„œ - êµìœ¡ë¹„</option>
                <option value="software_expense">ì§€ì¶œí’ˆì˜ì„œ - ì†Œí”„íŠ¸ì›¨ì–´</option>
                <option value="ip_expense">ì§€ì¶œí’ˆì˜ì„œ - ì§€ì‹ì¬ì‚°ê¶Œ</option>
                <option value="travel_expense_claim">ì§€ì¶œìŠ¹ì¸ìš”ì²­ì„œ - êµí†µì—¬ë¹„ ì²­êµ¬</option>
                <option value="business_trip_report">ì¶œì¥í’ˆì˜ì„œ - ì§€ì¶œì •ë³´</option>
            </select>
        </div>
        <div class="section">
            <div class="header-controls">
                <h2>1. ê³µí†µ ì •ë³´ ì…ë ¥</h2>
            </div>
            <div class="grid" id="common-inputs-container"></div>
            <div id="common-restore-section" class="restore-section" style="display: none;"></div>
            <button id="apply-common-btn" class="button" style="margin-top: 1rem;">[â†“] ëª¨ë“  í•­ëª©ì— ê³µí†µ ì •ë³´ ì ìš©</button>
        </div>
    </div>

    <div class="expandable-width-container">
        <div class="section">
            <div class="header-controls">
                <h2>2. ì„¸ë¶€ í•­ëª© ì…ë ¥</h2>
                <button id="add-item-btn" class="button button-secondary">[+] í•­ëª© ì¶”ê°€</button>
            </div>
            <div id="items-container-wrapper">
                <div id="items-container"></div>
            </div>
            <div id="item-restore-section" class="restore-section" style="display: none;"></div>
        </div>
    </div>

    <div class="fixed-width-container">
        <button id="copyBtn" class="button" style="width:100%; padding: 1rem; font-size: 1.2rem;">ğŸš€ ìµœì¢… ì–‘ì‹ ìƒì„± ë° ë³µì‚¬</button>
        <div id="copyFeedback">âœ… ë³µì‚¬ ì™„ë£Œ! WEHAGOì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</div>
    </div>
</div>

<div class="version-info">
    Version 2.0 (2025.10.01)
</div>

<script>
    const vendors = {
        'íŠ¹í—ˆë²•ì¸ ë¹„ì—˜í‹°': { paymentMethod: 'ìš´ì˜ê³„ì¢Œ ì´ì²´', account: 'ìš°ë¦¬ì€í–‰ / 1005303954125 / ì˜ˆê¸ˆì£¼ : íŠ¹í—ˆë²•ì¸ ë¹„ì—˜í‹°' },
        'ë©”íŠ¸ë¡œì‹¤ë¦¬ì½˜': { paymentMethod: 'ìš´ì˜ê³„ì¢Œì´ì²´', account: 'êµ­ë¯¼ì€í–‰ / 465701-04-054612 / ì˜ˆê¸ˆì£¼ : ë©”íŠ¸ë¡œì‹¤ë¦¬ì½˜' },
        'íŠ¹í—ˆë²•ì¸ OO': { paymentMethod: 'ìš´ì˜ê³„ì¢Œì´ì²´', account: 'êµ­ë¯¼ì€í–‰ / 401234-74-786355 / ì˜ˆê¸ˆì£¼ : íŠ¹í—ˆë²•ì¸ OO' },
        'OOìº í¼ìŠ¤': { paymentMethod: 'ìš´ì˜ê³„ì¢Œì´ì²´', account: 'êµ­ë¯¼ì€í–‰ / 504401-45-404568 / ì˜ˆê¸ˆì£¼ : OOìº í¼ìŠ¤' },
    };

    const BASE_COMMON_FIELDS = [
        { id: 'vendor', label: 'ê±°ë˜ì²˜/êµ¬ì…ì²˜/ìš©ì—­ì—…ì²´', example: 'ë„¤ì´ë²„í˜ì´, ì§€ì˜¤ë¹„ì „ ë“±' },
        { id: 'paymentMethod', label: 'ê²°ì œìˆ˜ë‹¨', example: 'ìš´ì˜ê³„ì¢Œì´ì²´, ê°œì¸ë²•ì¸ì¹´ë“œ ë“±' },
        { id: 'account', label: 'ì…ê¸ˆê³„ì¢Œ', example: 'êµ­ë¯¼ì€í–‰ / 465701-04-054612 / ì˜ˆê¸ˆì£¼ : OOO' },
        { id: 'purpose', label: 'ì§€ì¶œ/êµ¬ë§¤/ìš©ì—­ ëª©ì  ë° í•„ìš”ì„±', example: 'êµ¬ë§¤ë¥¼ ìš”ì²­í•˜ëŠ” ì´ìœ  Â· í•„ìš”ì„±' },
    ];

    const FIELD = {
        itemName: { id: 'itemName', label: 'í’ˆëª©ëª…/ì§€ì¶œëª…', example: 'ì—…ë¬´ìš© ëª¨ë‹ˆí„°, ì‹œë®¬ë ˆì´ì…˜ìš© ì„œë²„' },
        spec: { id: 'spec', label: 'ê·œê²©/ì„¤ëª…/ìš©ì—­ë‚´ìš©/ì§€ì¶œë‚´ìš©', example: 'ê°„ëµí•œ ì„¸ë¶€ ë‚´ìš©' },
        qty: { id: 'qty', label: 'ìˆ˜ëŸ‰', example: '2, 4' },
        unitPrice: { id: 'unitPrice', label: 'ë‹¨ê°€(ì›)', example: '22,000,000 ì› / 10 USD' },
        amount: { id: 'amount', label: 'ì´ ê¸ˆì•¡(ë¶€ê°€ì„¸ í¬í•¨)', example: '44,000,000 ì› / 40 USD' },
        date: { id: 'date', label: 'êµ¬ë§¤/ì§€ì¶œì¼ì', example: '2024. 6. 18.' },
        note: { id: 'note', label: 'ê¸°íƒ€ì‚¬í•­', example: 'íŠ¹ë³„ ìš”ì²­ì‚¬í•­ ë˜ëŠ” ë¶€ê°€ ì •ë³´' },
        user: { id: 'user', label: 'ì‚¬ìš©ì/ì‹ ì²­ì', example: 'ì‚¬ìš©í•  ì„ì§ì›, ë¶€ì„œ, ê³µìš© ë“±' },
        manufacturer: { id: 'manufacturer', label: 'ì œì¡°ì‚¬', example: 'í•œì„±ì»´í“¨í„°, MS, ì¶œíŒì‚¬ ë“±' },
        isRecurring: { id: 'isRecurring', label: 'ì •ê¸°ê²°ì œ ì—¬ë¶€', example: 'ì¼ì‹œë‚© / ë§¤ë…„ / ë§¤ì›” ë“±' },
        recurringPeriod: { id: 'recurringPeriod', label: 'ìë™ ê²°ì œ ê¸°ê°„', example: 'ë¬´ê¸°í•œ, 2023.3.14 ~ 2024.3.14' },
        recurringDate: { id: 'recurringDate', label: 'ìë™ ê²°ì œì¼', example: 'ë§¤ë‹¬ 10ì¼, ë§¤ë…„ 3ì›” ë‘˜ì§¸ ì£¼ ë“±' },
        paymentTerms: { id: 'paymentTerms', label: 'ì§€ê¸‰ ì¡°ê±´', example: 'ê³„ì•½ê¸ˆ: ê³„ì•½ í›„ 7ì¼ ì´ë‚´ ì´ ê¸ˆì•¡ì˜ 30% ì§€ê¸‰' },
        place: { id: 'place', label: 'ì¥ì†Œ/êµìœ¡ì¥ì†Œ', example: 'ì˜¨ë¼ì¸, ë¼ë±ì…€ íšŒì˜ì‹¤ ë“±' },
        attendees: { id: 'attendees', label: 'ì°¸ì„ì/êµìœ¡ëŒ€ìƒ', example: 'ëŒ€ìƒ ì§ì›, ë¶€ì„œ, ì „ ì„ì§ì› ë“±' },
        service: { id: 'service', label: 'ìš©ì—­ëª…', example: 'ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ ì™¸ì£¼ ìš©ì—­' },
        periodFrom: { id: 'periodFrom', label: 'ê¸°ê°„(ì‹œì‘)', example: '2024. 6. 18.' },
        periodTo: { id: 'periodTo', label: 'ê¸°ê°„(ì¢…ë£Œ)', example: '2024. 7. 18.' },
        course: { id: 'course', label: 'êµìœ¡ëª…ì¹­', example: 'ë°ì´í„°ë¶„ì„ ì‹¤ë¬´ ê°•ì˜' },
        provider: { id: 'provider', label: 'ê°•ì‚¬/êµìœ¡ê¸°ê´€', example: 'í™ê¸¸ë™/íŒ¨ìŠ¤íŠ¸ìº í¼ìŠ¤' },
        relatedTask: { id: 'relatedTask', label: 'ê´€ë ¨ ì—…ë¬´', example: 'OOO í”„ë¡œì íŠ¸' },
        license: { id: 'license', label: 'ì œí’ˆ/ë¼ì´ì„ ìŠ¤ëª…', example: 'ë¯¸ë¡œë³´ë“œ ë¹„ì¦ˆë‹ˆìŠ¤ í”Œëœ' },
        seats: { id: 'seats', label: 'ë¼ì´ì„ ìŠ¤ ìˆ˜', example: '2, 4' },
        origin: { id: 'origin', label: 'ì¶œë°œì§€', example: 'íšŒì‚¬' },
        destination:{ id: 'destination',label: 'ë„ì°©ì§€', example: 'ê°•ì›ëŒ€ë³‘ì›' },
        tripObjective:{id: 'tripObjective',label:'ì¶œì¥ ëª©ì ', example: 'ì˜ë£Œê¸°ê¸° ì„¤ì¹˜' },
        proof: { id: 'proof', label: 'ì¦ë¹™ìë£Œ', example: 'ë„¤ì´ë²„ ê¸¸ì°¾ê¸° ìº¡ì²˜ ì²¨ë¶€' },
        expenseTransit:{ id:'expenseTransit',label:'êµí†µë¹„', example: 'í•­ê³µë£Œ, ê¸°ì°¨ë£Œ ë“± ì´ ê¸ˆì•¡' },
        expenseLodging:{id:'expenseLodging',label:'ìˆ™ë°•ë¹„', example: 'ìˆ™ë°•ë¹„ ì´ ê¸ˆì•¡' },
        expenseMeal:{id:'expenseMeal',label:'ì‹ë¹„', example: 'ì—…ë¬´ ê´€ë ¨ ì‹ì‚¬ ë¹„ìš©' },
        expenseOther:{id:'expenseOther',label:'ê¸°íƒ€ë¹„ìš©', example: 'ê¸°íƒ€ ë¹„ìš© ì´ ê¸ˆì•¡' },
        ipMgmtNo: { id: 'ipMgmtNo', label: 'íŠ¹í—ˆ ê´€ë¦¬ë²ˆí˜¸', example: 'BPP2021-0030US' },
        invoiceNo: { id: 'invoiceNo', label: 'ì²­êµ¬ì„œ ë²ˆí˜¸', example: 'SPS24-2336' },
    };

    const T = (title, ...fields) => ({ title, fields: [...BASE_COMMON_FIELDS, ...Object.values(FIELD).filter(f => fields.includes(f))] });

    const formTemplates = {
        'general_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì¼ë°˜', FIELD.itemName, FIELD.unitPrice, FIELD.qty, FIELD.manufacturer, FIELD.amount, FIELD.isRecurring, FIELD.recurringPeriod, FIELD.recurringDate, FIELD.date, FIELD.paymentTerms, FIELD.user, FIELD.note),
        'meeting_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì‚¬ë‚´ ì‚¬ì™¸ íšŒì˜ë¹„', FIELD.itemName, FIELD.amount, FIELD.user, FIELD.note),
        'outsourcing_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì™¸ì£¼ìš©ì—­', FIELD.service, FIELD.periodFrom, FIELD.periodTo, FIELD.spec, FIELD.user, FIELD.amount, FIELD.isRecurring, FIELD.recurringPeriod, FIELD.recurringDate, FIELD.paymentTerms, FIELD.note),
        'education_expense': T('ì§€ì¶œí’ˆì˜ì„œ - êµìœ¡ë¹„', FIELD.course, FIELD.provider, FIELD.periodFrom, FIELD.periodTo, FIELD.place, FIELD.attendees, FIELD.amount, FIELD.relatedTask, FIELD.note),
        'software_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì†Œí”„íŠ¸ì›¨ì–´', FIELD.license, FIELD.unitPrice, FIELD.seats, FIELD.manufacturer, FIELD.amount, FIELD.isRecurring, FIELD.recurringPeriod, FIELD.recurringDate, FIELD.date, FIELD.paymentTerms, FIELD.user, FIELD.note),
        'ip_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì§€ì‹ì¬ì‚°ê¶Œ', FIELD.spec, FIELD.ipMgmtNo, FIELD.invoiceNo, FIELD.amount, FIELD.paymentTerms, FIELD.note),
        'travel_expense_claim': T('ì§€ì¶œìŠ¹ì¸ìš”ì²­ì„œ - êµí†µì—¬ë¹„ ì²­êµ¬', FIELD.date, FIELD.origin, FIELD.destination, FIELD.tripObjective, FIELD.amount, FIELD.proof),
        'business_trip_report': T('ì¶œì¥í’ˆì˜ì„œ - ì§€ì¶œì •ë³´', FIELD.tripObjective, FIELD.place, FIELD.expenseTransit, FIELD.expenseLodging, FIELD.expenseMeal, FIELD.expenseOther, FIELD.amount, FIELD.note),
    };

    let items = [{}];
    let currentFormType = 'general_expense';
    let pinnedFields = [];
    let hiddenFields = [];

    const expandableContainer = document.querySelector('.expandable-width-container');
    const commonInputsContainer = document.getElementById('common-inputs-container');
    const itemsContainer = document.getElementById('items-container');
    const addItemBtn = document.getElementById('add-item-btn');
    const applyCommonBtn = document.getElementById('apply-common-btn');
    const copyBtn = document.getElementById('copyBtn');
    const formTypeSelector = document.getElementById('masterFormType');
    const resetBtn = document.getElementById('reset-btn');

    const saveState = () => localStorage.setItem('wehagoFormData', JSON.stringify({ items, currentFormType, pinnedFields, hiddenFields }));
    const loadState = () => {
        try {
            const savedState = localStorage.getItem('wehagoFormData');
            if (savedState) {
                const data = JSON.parse(savedState);
                items = data.items && data.items.length > 0 ? data.items : [{}];
                currentFormType = data.currentFormType || 'general_expense';
                pinnedFields = data.pinnedFields || [];
                hiddenFields = data.hiddenFields || [];
                formTypeSelector.value = currentFormType;
            }
        } catch (e) { console.error("Could not load state", e); }
    };

    const adjustContainerWidth = () => {
        const section = expandableContainer.querySelector('.section');
        const bodyPadding = parseFloat(getComputedStyle(document.body).paddingLeft) * 2;
        const sectionPadding = parseFloat(getComputedStyle(section).paddingLeft) * 2;
        const maxAllowedWidth = window.innerWidth - bodyPadding;
        const cardWidth = 320;
        const cardGap = 1.5 * 16;
        const defaultWidth = 900;
        let requiredContainerWidth = (items.length <= 1) ? defaultWidth : ((items.length + 1) * cardWidth) + (items.length * cardGap) + sectionPadding;
        const finalContainerWidth = Math.min(requiredContainerWidth, maxAllowedWidth);
        expandableContainer.style.maxWidth = `${Math.max(finalContainerWidth, defaultWidth)}px`;
        const actualContentWidth = (items.length * cardWidth) + (Math.max(0, items.length - 1) * cardGap);
        itemsContainer.style.width = items.length > 1 ? `${actualContentWidth}px` : '100%';
    };

    function render() {
        const template = formTemplates[currentFormType];
        const baseCommonIds = BASE_COMMON_FIELDS.map(f => f.id);

        const allCommonFields = template.fields.filter(f => baseCommonIds.includes(f.id) || pinnedFields.includes(f.id));
        const allItemFields = template.fields.filter(f => !baseCommonIds.includes(f.id) && !pinnedFields.includes(f.id));

        const visibleCommonFields = allCommonFields.filter(f => !hiddenFields.includes(f.id));
        const visibleItemFields = allItemFields.filter(f => !hiddenFields.includes(f.id));

        const hiddenCommonFields = allCommonFields.filter(f => hiddenFields.includes(f.id));
        const hiddenItemFields = allItemFields.filter(f => hiddenFields.includes(f.id));

        commonInputsContainer.innerHTML = visibleCommonFields.map(field => {
            const isPinned = pinnedFields.includes(field.id);
            const pinButton = isPinned ? `<button class="icon-btn" data-field-id="${field.id}" title="ì„¸ë¶€ í•­ëª©ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°">ğŸ“Œ</button>` : '';
            let inputHtml = `<div><div class="label-wrapper"><label for="common_${field.id}">${field.label}</label><div class="label-icons">${pinButton}<button class="icon-btn hide-btn" data-field-id="${field.id}" title="í•­ëª© ìˆ¨ê¸°ê¸°">Ã—</button></div></div>`;
            if (field.id === 'vendor') {
                inputHtml += `<select id="common_${field.id}"><option value="">-- ì§ì ‘ ì…ë ¥ --</option>${Object.keys(vendors).map(k => `<option value="${k}">${k}</option>`).join('')}</select>`;
            } else {
                inputHtml += `<input type="text" id="common_${field.id}" placeholder="${field.example || ''}">`;
            }
            return inputHtml + `</div>`;
        }).join('');

        renderRestoreSection('common-restore-section', hiddenCommonFields);

        itemsContainer.innerHTML = items.map((itemData, index) => {
            return `
                <div class="item-card" data-index="${index}">
                    <div class="item-header"><h3>í•­ëª© ${index + 1}</h3>${items.length > 1 ? '<button class="remove-item-btn" title="í•­ëª© ì‚­ì œ">Ã—</button>' : ''}</div>
                    <div class="item-fields-container">${visibleItemFields.map(field => `
                        <div>
                            <div class="label-wrapper">
                                <label for="${field.id}_${index}">${field.label}</label>
                                <div class="label-icons">
                                    <button class="icon-btn" data-field-id="${field.id}" title="ê³µí†µ í•­ëª©ìœ¼ë¡œ ê³ ì •">ğŸ“Œ</button>
                                    <button class="icon-btn hide-btn" data-field-id="${field.id}" title="í•­ëª© ìˆ¨ê¸°ê¸°">Ã—</button>
                                </div>
                            </div>
                            <input type="text" id="${field.id}_${index}" value="${itemData[field.id] || ''}" placeholder="${field.example || ''}">
                        </div>`
                    ).join('')}</div>
                </div>`;
        }).join('');

        renderRestoreSection('item-restore-section', hiddenItemFields);

        if (items.length === 1) itemsContainer.querySelector('.item-card')?.classList.add('single-item');
        adjustContainerWidth();
        saveState();
    }

    function renderRestoreSection(sectionId, hiddenFields) {
        const sectionEl = document.getElementById(sectionId);
        if (hiddenFields.length > 0) {
            sectionEl.style.display = 'block';
            sectionEl.innerHTML = `
                <h4>[+] ë³µì›í•  í•­ëª©ì„ í´ë¦­í•˜ì„¸ìš”</h4>
                <div class="restore-list">${hiddenFields.map(f => `<button class="restore-btn" data-field-id="${f.id}">${f.label}</button>`).join('')}</div>`;
        } else {
            sectionEl.style.display = 'none';
            sectionEl.innerHTML = '';
        }
    }

    function handleIconClick(e) {
        const btn = e.target.closest('.icon-btn');
        if (!btn) return;

        const fieldId = btn.dataset.fieldId;

        // This is a simplified check. A more robust way is to check classList.
        if (btn.title.includes('ê³ ì •')) { // Pinning
            const index = pinnedFields.indexOf(fieldId);
            if (index > -1) {
                // This logic is flawed, unpinning should happen in common section
            } else {
                pinnedFields.push(fieldId);
            }
        } else if (btn.title.includes('ë˜ëŒë¦¬ê¸°')) { // Unpinning
             const index = pinnedFields.indexOf(fieldId);
             if (index > -1) pinnedFields.splice(index, 1);
        } else if (btn.classList.contains('hide-btn')) {
            if (!hiddenFields.includes(fieldId)) {
                hiddenFields.push(fieldId);
            }
        }
        render();
    }

    function handleRestoreClick(e) {
        const restoreBtn = e.target.closest('.restore-btn');
        if (restoreBtn) {
            const fieldId = restoreBtn.dataset.fieldId;
            const index = hiddenFields.indexOf(fieldId);
            if(index > -1) {
                hiddenFields.splice(index, 1);
                render();
            }
        }
    }

    // A more robust icon handler
    function masterIconHandler(e) {
        const btn = e.target.closest('.icon-btn');
        if(!btn) return;
        const fieldId = btn.dataset.fieldId;

        if(btn.title.includes('ê³ ì •') || btn.title.includes('ë˜ëŒë¦¬ê¸°')) {
            const index = pinnedFields.indexOf(fieldId);
            if (index > -1) pinnedFields.splice(index, 1); // unpin
            else pinnedFields.push(fieldId); // pin
        } else if (btn.classList.contains('hide-btn')) {
            if (!hiddenFields.includes(fieldId)) hiddenFields.push(fieldId);
        }
        render();
    }

    document.getElementById('common-restore-section').addEventListener('click', handleRestoreClick);
    document.getElementById('item-restore-section').addEventListener('click', handleRestoreClick);
    commonInputsContainer.addEventListener('click', masterIconHandler);
    itemsContainer.addEventListener('click', (e) => {
        if(e.target.closest('.icon-btn')) masterIconHandler(e);
        if (e.target.classList.contains('remove-item-btn')) {
            items.splice(e.target.closest('.item-card').dataset.index, 1);
            if (items.length === 0) items.push({});
            render();
        }
    });

    applyCommonBtn.addEventListener('click', () => {
        const commonData = {};
        const commonFieldIds = [...BASE_COMMON_FIELDS.map(f => f.id), ...pinnedFields];

        commonFieldIds.forEach(fieldId => {
             const el = document.getElementById(`common_${fieldId}`);
             if (el) commonData[fieldId] = el.value;
        });

        items.forEach((item, index) => {
            Object.assign(item, commonData);
        });

        document.querySelectorAll('#common-inputs-container input, #common-inputs-container select').forEach(el => {
            el.classList.add('highlight');
            setTimeout(() => el.classList.remove('highlight'), 1200);
        });
        saveState();
    });

    addItemBtn.addEventListener('click', () => {
        items.push({});
        render();
        const newCard = itemsContainer.lastElementChild;
        if (newCard) {
            newCard.querySelector('input')?.focus();
            newCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    });

    itemsContainer.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT') {
            const index = e.target.closest('.item-card').dataset.index;
            const fieldId = e.target.id.split('_')[0];
            items[index][fieldId] = e.target.value;
            saveState();
        }
    });

    formTypeSelector.addEventListener('change', (e) => {
        if (confirm('ì–‘ì‹ì„ ë³€ê²½í•˜ë©´ í˜„ì¬ ì‘ì„±ëœ í•­ëª©ê³¼ ëª¨ë“  ì„¤ì •(í•€, ìˆ¨ê¹€)ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            currentFormType = e.target.value;
            items = [{}];
            pinnedFields = [];
            hiddenFields = [];
            render();
        } else {
            e.target.value = currentFormType;
        }
    });

    resetBtn.addEventListener('click', () => {
        if (confirm('ì •ë§ë¡œ ëª¨ë“  í•­ëª©ê³¼ ì„¤ì •(í•€, ìˆ¨ê¹€)ì„ ì§€ìš°ê³  ìƒˆë¡œ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            items = [{}];
            pinnedFields = [];
            hiddenFields = [];
            localStorage.removeItem('wehagoFormData');
            render();
            document.querySelectorAll('#common-inputs-container input, #common-inputs-container select').forEach(el => el.value = '');
        }
    });

    document.getElementById('common-inputs-container').addEventListener('change', e => {
        if (e.target.id === 'common_vendor') {
            const vendor = vendors[e.target.value];
            if (vendor) {
                const pmEl = document.getElementById('common_paymentMethod');
                const accEl = document.getElementById('common_account');
                if (pmEl) pmEl.value = vendor.paymentMethod || '';
                if (accEl) accEl.value = vendor.account || '';
            }
        }
    });

    copyBtn.addEventListener('click', () => {
        const template = formTemplates[currentFormType];
        const FONT = "font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; font-size: 10pt;";
        const TD_L = `padding: 8px; font-weight: bold; text-align: center; background-color: #f2f2f2; ${FONT}`;
        const TD_V = `padding: 8px; vertical-align: top; ${FONT}`;
        const header = `<tr><td style="${TD_L}">${template.title}</td>${items.map((_, i) => `<td style="text-align:center; font-weight:bold; background-color:#deebee; padding:8px; ${FONT}">í•­ëª© ${i+1}</td>`).join('')}</tr>`;

        const commonData = {};
        const commonFieldIds = [...BASE_COMMON_FIELDS.map(f => f.id), ...pinnedFields];
        commonFieldIds.forEach(fieldId => {
             const el = document.getElementById(`common_${fieldId}`);
             if (el) commonData[fieldId] = el.value;
        });

        const bodyRows = template.fields.map(field => {
            const isCommonField = commonFieldIds.includes(field.id);
            return `<tr><td style="${TD_L}">${field.label}</td>${items.map(item => {
                const value = isCommonField ? (commonData[field.id] || '') : (item[field.id] || '');
                return `<td style="${TD_V}">${(value || '').replace(/\n/g, '<br>')}</td>`;
            }).join('')}</tr>`;
        });

        const finalHtml = `<table border="1" style="border-collapse: collapse; width: 100%; ${FONT}"><thead>${header}</thead><tbody>${bodyRows}</tbody></table>`;
        try {
            navigator.clipboard.write([new ClipboardItem({ 'text/html': new Blob([finalHtml], { type: 'text/html' }) })]);
            const fb = document.getElementById('copyFeedback');
            fb.style.opacity = '1';
            setTimeout(() => { fb.style.opacity = '0'; }, 2000);
        } catch(e) {
            console.error(e);
            alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => { adjustContainerWidth(); }, 150);
    });

    loadState();
    render();
</script>
</body>
</html>

