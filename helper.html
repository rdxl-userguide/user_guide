<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>WEHAGO ì „ìê²°ì¬ í¼ ìƒì„±ê¸° (v3.3)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            /* [ìˆ˜ì •] ì‹œê·¸ë‹ˆì²˜ ë¸”ë£¨ ì ìš© (ë©”ì¸ ì»¬ëŸ¬) */
            --primary-color: #2C5CA3;
            /* [ìˆ˜ì •] í˜¸ë²„ ì‹œ ë” ê¹Šì€ ë¸”ë£¨ */
            --primary-hover: #1E447A; 
            
            --border-color: #e2e8f0;
            --background-light: #f7fafc;
            --background-white: #ffffff;
            --text-dark: #2d3748;
            --text-light: #718096;
            
            /* [ìˆ˜ì •] ì‹œê·¸ë‹ˆì²˜ ê·¸ë¦° ì ìš© (ì„±ê³µ/ì™„ë£Œ) */
            --success-color: #22A699; 
        }

        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        /* --- ë ˆì´ì•„ì›ƒ êµ¬ì¡° --- */
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--background-light);
            margin: 0;
            padding: 2rem;
            box-sizing: border-box;
        }

        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 2rem;
        }

        .fixed-width-container {
            width: 100%;
            max-width: 900px;
        }

        .expandable-width-container {
            width: 100%;
            max-width: 900px;
            /* JSì— ì˜í•´ ë™ì ìœ¼ë¡œ ë³€ê²½ë¨ */
            transition: max-width 0.4s ease-in-out;
            /* ë„ˆë¹„ ë³€ê²½ ì• ë‹ˆë©”ì´ì…˜ */
        }

        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        h1 {
            font-size: 2rem;
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 1rem;
        }

        .section {
            background: var(--background-white);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        }

        h2 {
            font-size: 1.25rem;
            color: var(--text-dark);
            margin-top: 0;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .label-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        label {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .label-icons {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        input,
        select {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-sizing: border-box;
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            /* [ìˆ˜ì •] íŒŒë€ìƒ‰(#2C5CA3)ì˜ íˆ¬ëª…ë„ ì¡°ì ˆ ë²„ì „ */
            box-shadow: 0 0 0 3px rgba(44, 92, 163, 0.15);
        }

        input::placeholder {
            color: #cbd5e0;
        }

        input:read-only,
        select:disabled {
            background-color: #f7fafc;
            color: #718096;
            cursor: not-allowed;
        }


        /* --- ì•ˆë‚´ ë¬¸êµ¬ ìŠ¤íƒ€ì¼ --- */
        .app-description {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 2.5rem;
            font-size: 0.9rem;
        }

        .section-description {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: -0.75rem;
            margin-bottom: 1.5rem;
            padding-left: 0.25rem;
        }

        /* --- ë²„íŠ¼ & ì•„ì´ì½˜ --- */
        .button {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
        }

        .button:hover {
            background-color: var(--primary-hover);
        }

        .button-secondary {
            background-color: #edf2f7;
            color: var(--text-dark);
        }

        .button-secondary:hover {
            background-color: #e2e8f0;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            line-height: 1;
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .icon-btn:hover {
            opacity: 1;
        }

        .hide-btn {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .lock-icon {
            cursor: default;
            opacity: 0.5;
        }

        /* --- ìˆ¨ê¹€/ë³µì› ê¸°ëŠ¥ --- */
        .restore-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px dashed var(--border-color);
        }

        .restore-section h4 {
            margin: 0 0 1rem 0;
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .restore-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .restore-btn {
            background-color: #edf2f7;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .restore-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* --- í•­ëª©(Item) ì¹´ë“œ --- */
        #items-container-wrapper {
            width: 100%;
            overflow-x: auto;
            margin-top: 1.5rem;
        }

        #items-container {
            display: flex;
            gap: 1.5rem;
            padding-bottom: 1rem;
        }

        .item-card {
            background-color: var(--background-light);
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 0.5rem;
            transition: opacity 0.3s, transform 0.3s;
            flex: 0 0 320px;
        }

        .item-card.single-item {
            flex: 1 1 auto;
        }

        .item-fields-container>div {
            margin-bottom: 1.25rem;
        }

        .item-fields-container>div:last-child {
            margin-bottom: 0;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .item-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .remove-item-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }

        /* --- UX ê°œì„  --- */
        #copyFeedback {
            text-align: center;
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 1rem;
            opacity: 0;
            transition: opacity 0.5s;
            height: 24px;
        }

        .highlight {
            transition: box-shadow 0.2s;
            /* [ìˆ˜ì •] í•˜ì´ë¼ì´íŠ¸ëŠ” ì´ˆë¡ìƒ‰(#22A699)ì„ ì‚¬ìš©í•˜ì—¬ 'ì ìš©ë¨/ì„±ê³µ' ì˜ë¯¸ ë¶€ì—¬ */
            box-shadow: 0 0 0 3px rgba(32, 182, 133, 0.5);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- í”¼ë“œë°± ë° ë²„ì „ ì •ë³´ --- */
        .footer-notice {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .footer-notice b {
            color: var(--text-dark);
            font-weight: 600;
        }

        /* --- AI Section ìŠ¤íƒ€ì¼ (Step 2 - ì¢Œìš° ë¶„í•  ë ˆì´ì•„ì›ƒ) --- */
        .ai-section {
            /* [ìˆ˜ì •] íšŒì‚¬ ì‹œê·¸ë‹ˆì²˜ ì»¬ëŸ¬ ê·¸ë¼ë°ì´ì…˜ (ë¸”ë£¨ -> ê·¸ë¦°) */
            background: linear-gradient(135deg, #2C5CA3 0%, #22A699 100%);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            color: white;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ ì „ì²´ íš¨ê³¼ */
        .ai-section.drag-over {
            transform: scale(1.005);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3);
            /* ë“œë˜ê·¸ ì‹œ ì¡°ê¸ˆ ë” ë°ì€ í†¤ìœ¼ë¡œ ë³€ê²½ */
            background: linear-gradient(135deg, #386CB8 0%, #2BCFA0 100%);
        }

        .ai-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .ai-header h3 {
            color: white;
            margin: 0 0 0.5rem 0;
            font-size: 1.4rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ai-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            margin: 0;
        }

        /* ì¢Œìš° ë¶„í•  ê·¸ë¦¬ë“œ */
        .ai-grid-container {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            /* ì™¼ìª½ 1 : ì˜¤ë¥¸ìª½ 1.2 ë¹„ìœ¨ */
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* (ì™¼ìª½) ì—…ë¡œë“œ ì¹´ë“œ */
        .upload-card {
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 220px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        .upload-text {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .upload-sub {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* (ì˜¤ë¥¸ìª½) íŒŒì¼ ëª©ë¡ & ì§€ì‹œì‚¬í•­ */
        .info-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼ ë°•ìŠ¤ (ì–´ë‘ìš´ ë°°ê²½) */
        #file-list-box {
            flex: 1;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            overflow-y: auto;
            max-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* ë‚´ìš© ì—†ì„ ë•Œ ì¤‘ì•™ ì •ë ¬ */
        }

        .file-item {
            padding: 0.4rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        /* ì§€ì‹œì‚¬í•­ ì…ë ¥ (í°ìƒ‰ ë°•ìŠ¤) */
        .instruction-box {
            background: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .instruction-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.95rem;
            color: var(--text-dark);
            background: transparent;
            padding: 0;
            height: auto;
            /* ê¸°ì¡´ input ë†’ì´ ì´ˆê¸°í™” */
        }

        .instruction-box input:focus {
            box-shadow: none;
        }

        /* í•˜ë‹¨ ë¶„ì„ ë²„íŠ¼ */
        #run-analysis-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            /* [ìˆ˜ì •] ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ë©”ì¸ ë¸”ë£¨ ì»¬ëŸ¬ë¡œ */
            color: var(--primary-color);
            font-weight: 800;
            border: none;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #run-analysis-btn:hover:not([disabled]) {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            /* [ìˆ˜ì •] í˜¸ë²„ ì‹œ í…ìŠ¤íŠ¸ëŠ” ì´ˆë¡ìƒ‰ìœ¼ë¡œ í¬ì¸íŠ¸ */
            color: var(--success-color);
        }

        #run-analysis-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 768px) {
            .ai-grid-container {
                grid-template-columns: 1fr;
            }

            .upload-card {
                min-height: 150px;
            }
        }


        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 1rem;
            z-index: 10;
            color: var(--text-dark);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- [UX ê°œì„ ] ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸° ë° ì¶”ê°€ --- */

        /* 1. ì¹´ë“œ ë° ì„¹ì…˜ ë””ìì¸: ë” ê¹Šì€ ê·¸ë¦¼ìì™€ ì—¬ìœ ë¡œìš´ ê°„ê²© */
        .section,
        .item-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04) !important;
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
        }

        /* 2. ì•„ì´ì½˜ ë²„íŠ¼: í´ë¦­ ì˜ì—­ í™•ëŒ€ ë° í˜¸ë²„ íš¨ê³¼ */
        .icon-btn {
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            color: var(--text-light);
            opacity: 0.6;
        }

        .icon-btn:hover {
            background-color: #edf2f7;
            color: var(--primary-color);
            opacity: 1;
            transform: scale(1.1);
        }

        /* 3. AI ì„¹ì…˜: ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì‹œê°í™” ê°•í™” */
        .ai-section {
            border: 2px dashed rgba(255, 255, 255, 0.4);
            /* ì´ë¯¸ ìœ„ì—ì„œ ê·¸ë¼ë°ì´ì…˜ ì •ì˜ë¨ */
        }

        /* 4. [New] í† ìŠ¤íŠ¸ ì•Œë¦¼ (Toast Notification) */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background-color: var(--text-dark);
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toast-container.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* --- ê³ ê¸‰ ì„¤ì • (ë””ìì¸ ìˆ˜ì •ë³¸ - ê¸€ììƒ‰ ìˆ˜ì •) --- */

        /* ì• ë‹ˆë©”ì´ì…˜ ì»¨í…Œì´ë„ˆ */
        #ai-advanced-options {
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 0;
            transform: translateY(-10px);
        }

        #ai-advanced-options.open {
            max-height: 500px;
            opacity: 1;
            transform: translateY(0);
            margin-top: 1.5rem;
        }

        /* ë‚´ë¶€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (ìœ ë¦¬ íš¨ê³¼) */
        .advanced-settings-box {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: left;
            color: white !important;
            /* ë°•ìŠ¤ ë‚´ ê¸°ë³¸ ê¸€ììƒ‰ í°ìƒ‰ ê°•ì œ */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* ë¼ë””ì˜¤ ë²„íŠ¼ í–‰ ì •ë ¬ */
        .radio-row {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        /* ë¼ë²¨ ìŠ¤íƒ€ì¼ (í°ìƒ‰ ê°•ì œ ì ìš©) */
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #ffffff !important;
            /* [ìˆ˜ì •ë¨] ê¸°ì¡´ íšŒìƒ‰ label ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸° */
        }

        .radio-label input[type="radio"] {
            margin-right: 0.5rem;
            width: 1.1rem;
            height: 1.1rem;
            accent-color: white;
            cursor: pointer;
            appearance: auto;
            box-shadow: none;
            border: none;
        }

        .radio-label span {
            color: #ffffff !important;
            /* [ìˆ˜ì •ë¨] í…ìŠ¤íŠ¸ spanë„ í™•ì‹¤í•˜ê²Œ í°ìƒ‰ìœ¼ë¡œ */
        }

        /* í•˜ìœ„ ì˜µì…˜ (ë‚˜ëˆ„ê¸° ìƒì„¸) */
        #split-detail-options {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed rgba(255, 255, 255, 0.5);
            /* ì ì„ ë„ ë” ë°ê²Œ */
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            color: white !important;
        }

        /* ìˆ«ì ì…ë ¥ì°½ */
        #manualCountInput {
            width: 60px !important;
            padding: 0.3rem !important;
            border-radius: 0.4rem !important;
            border: none !important;
            text-align: center;
            font-weight: bold;
            /* [ìˆ˜ì •] ì…ë ¥ëœ ìˆ«ìëŠ” ë©”ì¸ ë¸”ë£¨ ì»¬ëŸ¬ë¡œ */
            color: var(--primary-color); 
            background: white;
            height: 30px !important;
            margin: 0 0.5rem;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>

<body>

    <div class="main-wrapper">
        <button id="settings-btn" class="settings-btn" title="ì„¤ì •">âš™ï¸</button>
        <div class="fixed-width-container">
            <h1>WEHAGO ì „ìê²°ì¬ í¼ ìƒì„±ê¸° ğŸ’¡</h1>
            <p class="app-description">ëª¨ë“  ì…ë ¥ ë‚´ìš©ê³¼ ì„¤ì •ì€ ìƒˆë¡œê³ ì¹¨í•´ë„ ìë™ìœ¼ë¡œ ë³µì›ë©ë‹ˆë‹¤.</p>

            <div class="section" style="margin-bottom: 2rem; border: 2px solid var(--primary-color);">
                <div class="header-controls">
                    <h2>0. ì–‘ì‹ ì¢…ë¥˜ ì„ íƒ (Step 1)</h2>
                    <button id="reset-btn" class="button button-secondary" style="padding: 0.5rem 1rem;">[â†»] ìƒˆë¡œ
                        ì‘ì„±</button>
                </div>
                <select id="masterFormType" class="button"
                    style="width:100%; text-align:left; margin-top: 1rem; background-color: white; color: var(--text-dark); border: 1px solid var(--border-color);">
                    <option value="general_expense">ì§€ì¶œí’ˆì˜ì„œ - ì¼ë°˜</option>
                    <option value="meeting_expense">ì§€ì¶œí’ˆì˜ì„œ - ì‚¬ë‚´ ì‚¬ì™¸ íšŒì˜ë¹„</option>
                    <option value="outsourcing_expense">ì§€ì¶œí’ˆì˜ì„œ - ì™¸ì£¼ìš©ì—­</option>
                    <option value="education_expense">ì§€ì¶œí’ˆì˜ì„œ - êµìœ¡ë¹„</option>
                    <option value="software_expense">ì§€ì¶œí’ˆì˜ì„œ - ì†Œí”„íŠ¸ì›¨ì–´</option>
                    <option value="ip_expense">ì§€ì¶œí’ˆì˜ì„œ - ì§€ì‹ì¬ì‚°ê¶Œ</option>
                    <option value="travel_expense_claim">ì§€ì¶œìŠ¹ì¸ìš”ì²­ì„œ - êµí†µì—¬ë¹„ ì²­êµ¬</option>
                    <option value="business_trip_report">ì¶œì¥í’ˆì˜ì„œ - ì§€ì¶œì •ë³´</option>
                </select>
            </div>

            <div class="ai-section" id="drop-zone">
                <div id="ai-loading" class="loading-overlay" style="display: none; border-radius: 1rem;">
                    <div class="spinner"></div>
                    <p id="loading-text" style="color: var(--text-dark); font-weight: bold;">ë¶„ì„ ì¤‘...</p>
                </div>

                <div class="ai-header">
                    <h3>ğŸ¤– AI ìë™ ì…ë ¥ (Step 2)</h3>
                    <p>ì˜ìˆ˜ì¦, ê²¬ì ì„œ, ì—‘ì…€ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ ì„ íƒí•˜ì—¬ í¼ì„ ìë™ìœ¼ë¡œ ì™„ì„±í•©ë‹ˆë‹¤.</p>
                </div>

                <div class="ai-grid-container">

                    <div class="upload-card" onclick="document.getElementById('file-input').click()">
                        <div class="upload-icon">ğŸ“‚</div>
                        <div class="upload-text">íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</div>
                        <div class="upload-sub">ì´ë¯¸ì§€, PDF, Excel, Word ì§€ì›</div>
                        <input type="file" id="file-input"
                            accept="image/*,application/pdf,.xlsx,.xls,.docx,.doc,.txt,.csv" multiple
                            style="display: none;">
                    </div>

                    <div class="info-panel">
                        <div id="file-list-box">
                            <div style="text-align: center; color: rgba(255,255,255,0.6);">
                                ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        </div>

                        <div class="instruction-box">
                            <span style="font-size: 1.2rem;">ğŸ’¡</span>
                            <input type="text" id="user-instruction" placeholder="AI ì§€ì‹œì‚¬í•­ (ì˜ˆ: ìš´ì˜ê³„ì¢Œì—ì„œ ì´ì²´í• ê²Œ. ë¶€ê°€ì„¸ëŠ” 10%ì„.)">
                        </div>
                    </div>
                </div>

                <button id="run-analysis-btn" disabled>
                    ğŸš€ íŒŒì¼ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”
                </button>

                <div style="margin-top: 1.5rem; text-align: center;">
                    <button id="toggle-advanced-btn"
                        style="background:none; border:none; color:rgba(255,255,255,0.8); cursor:pointer; font-size:0.9rem; text-decoration: underline; transition: color 0.2s; display: inline-flex; align-items: center; gap: 0.3rem;">
                        âš™ï¸ ê³ ê¸‰ ì„¤ì • (í•©ì‚°/ë¶„ë¦¬ ë°©ì‹)
                    </button>

                    <div id="ai-advanced-options">
                        <div class="advanced-settings-box">
                            <div class="radio-row">
                                <label class="radio-label">
                                    <input type="radio" name="aiMode" value="merge" checked
                                        onclick="toggleSplitOptions()">
                                    <span>ğŸ“„ 1ê±´ìœ¼ë¡œ í•©ì¹˜ê¸°</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="aiMode" value="split" onclick="toggleSplitOptions()">
                                    <span>ğŸ“‘ ì—¬ëŸ¬ ê±´ìœ¼ë¡œ ë‚˜ëˆ„ê¸°</span>
                                </label>
                            </div>

                            <div id="split-detail-options" style="display: none;">
                                <label class="radio-label">
                                    <input type="radio" name="splitType" value="auto" checked>
                                    <span>ğŸ¤– AI ìë™ ë¶„ë¦¬ (ë‚´ìš©ì— ë”°ë¼ ì•Œì•„ì„œ)</span>
                                </label>

                                <div class="radio-row" style="margin-bottom: 0; gap: 0.5rem;">
                                    <label class="radio-label">
                                        <input type="radio" name="splitType" value="manual">
                                        <span>ğŸ”¢ ì§ì ‘ ì§€ì •: </span>
                                    </label>
                                    <input type="number" id="manualCountInput" min="2" max="20" value="2">
                                    <span>ê±´ìœ¼ë¡œ ë‚˜ëˆ„ê¸°</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>



            <div class="section">
                <div class="header-controls">
                    <h2>1. ê³µí†µ ì •ë³´ ì…ë ¥</h2>
                </div>
                <p class="section-description">
                    ì—¬ê¸°ì—ì„œ ì…ë ¥í•œ ê°’ì€ ëª¨ë“  ì„¸ë¶€ í•­ëª©ì— ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤.<br>
                    ê³µí†µ í•­ëª©(ğŸ”’)ì€ ì•„ë˜ ì¹´ë“œì—ë„ ê°™ì€ ìˆœì„œë¡œ í•¨ê»˜ í‘œì‹œë˜ë©°, ğŸ”“ì„ ëˆŒëŸ¬ ê°œë³„ ì…ë ¥ìœ¼ë¡œ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="grid" id="common-inputs-container"></div>
                <div id="common-restore-section" class="restore-section" style="display: none;"></div>
                <button id="apply-common-btn" class="button" style="margin-top: 1rem;">[â†“] ì ìš©ëœ ê³µí†µ í•­ëª© í™•ì¸</button>
            </div>
        </div>

        <div class="expandable-width-container">
            <div class="section">
                <div class="header-controls">
                    <h2>2. ì„¸ë¶€ í•­ëª© ì…ë ¥</h2>
                    <button id="add-item-btn" class="button button-secondary">[+] í•­ëª© ì¶”ê°€</button>
                </div>
                <p class="section-description">
                    ê° ì¹´ë“œì—ì„œ ê°’ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    ğŸ“Œì„ ëˆ„ë¥´ë©´ í•´ë‹¹ í•„ë“œê°€ ê³µí†µ í•­ëª©(ğŸ”’)ìœ¼ë¡œ ìŠ¹ê²©ë˜ì–´ ëª¨ë“  ì¹´ë“œì— ê³µìœ ë©ë‹ˆë‹¤.
                </p>
                <div id="items-container-wrapper">
                    <div id="items-container"></div>
                </div>
                <div id="item-restore-section" class="restore-section" style="display: none;"></div>
            </div>
        </div>

        <div class="fixed-width-container">
            <button id="copyBtn" class="button" style="width:100%; padding: 1rem; font-size: 1.2rem;">ğŸš€ ìµœì¢… ì–‘ì‹ ìƒì„± ë°
                ë³µì‚¬</button>
            <div id="copyFeedback">âœ… ë³µì‚¬ ì™„ë£Œ! WEHAGOì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</div>
        </div>
    </div>

    <div class="footer-notice">
        <p>
            ìœ„í•˜ê³  í¼ ìƒì„±ê¸° ë² íƒ€ í…ŒìŠ¤íŠ¸ (v4.1-AI ì ìš©)<br>
            ê±°ë˜ì²˜ ì¶”ê°€ ìš”ì²­ì´ë‚˜ ê°œì„  ì˜ê²¬ì€ ì–¸ì œë“ ì§€ í™˜ì˜í•©ë‹ˆë‹¤. ê²½ì˜ê¸°íšíŒ€ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.<br>
            <b>FOR RADEXEL INC. USE ONLY</b>
        </p>
    </div>

    <!-- API Key Modal -->
    <div class="modal-overlay" id="api-key-modal">
        <div class="modal-content">
            <h2 style="margin-top: 0;">ì„¤ì •</h2>
            <p style="color: var(--text-light); font-size: 0.9rem;">
                Google Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
                í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </p>
            <div style="margin-bottom: 1.5rem;">
                <label for="api-key-input" style="display: block; margin-bottom: 0.5rem;">API Key</label>
                <input type="password" id="api-key-input" placeholder="AIzaSy..."
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-family: monospace;">
                <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank"
                        style="color: var(--primary-color);">API Key ë°œê¸‰ë°›ê¸° (Google AI Studio)</a>
                </div>
            </div>
            <div style="text-align: right; gap: 0.5rem; display: flex; justify-content: flex-end;">
                <button id="close-modal-btn" class="button button-secondary">ë‹«ê¸°</button>
                <button id="save-api-key-btn" class="button">ì €ì¥</button>
            </div>
        </div>
    </div>
    </div>


    <script>
        // --- (v4.1) AI í•™ìŠµìš© ê³¼ê±° ë°ì´í„° (CSV ê¸°ë°˜ ë‚´ì¥) ---
        const historicalDB = [
            { category: "í•˜ë“œì›¨ì–´ ì œì‘", vendor: "ê²½ê¸°FA", itemName: "í•˜ë“œì›¨ì–´_ë¨¸ì‹œë‹ì„¼í„° ì œì‘ ê±´", purpose: "í•˜ë“œì›¨ì–´_ë¨¸ì‹œë‹ì„¼í„° ì œì‘", account: "ê¸°ì—…ì€í–‰ 471-036753-01-026", paymentMethod: "ì´ì²´(KARA)" },
            { category: "í•˜ë“œì›¨ì–´ ì œì‘", vendor: "121-87-02591", itemName: "Blade_ë¡œë´‡ë¶€_í•˜ë“œì›¨ì–´_ì•Œë£¨ë¯¸ëŠ„ìš©ì ‘ë¬¼ ì œì‘ ê±´", purpose: "Blade_ë¡œë´‡ë¶€_í•˜ë“œì›¨ì–´_ì•Œë£¨ë¯¸ëŠ„ìš©ì ‘ë¬¼ ì œì‘", account: "ê¸°ì—…ì€í–‰ 920-049581-04-019", paymentMethod: "ì´ì²´(ìš´ì˜ë¹„)" },
            { category: "ìë¬¸ë£Œ", vendor: "ì„œìš¸ì•„ì‚°ë³‘ì› ë°•ê¸°í™ ë°•ì‚¬", itemName: "ë ˆí¼ëŸ°ìŠ¤ ë¹” ë°ì´í„°ì— ëŒ€í•œ dicom ë¶„ì„ ìš©ì—­ìë¬¸ ì‹¤ì‹œ", purpose: "ì•„ì‚°ë³‘ì› ë¹”ë°ì´í„° ìµœì‹  ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•œ MC simulation ë¶„ì„ ì‹¤ì‹œ", account: "ì‹ í•œì€í–‰ / 254-910471-70707 / ì˜ˆê¸ˆì£¼ : ë°•ê¸°í™", paymentMethod: "ì´ì²´(ë°ì´í„°3ì°¨)" },
            { category: "ìˆ˜ë¦¬", vendor: "ì»´ë§ˆìŠ¤í„°", itemName: "ì—…ë¬´ìš© ë°ìŠ¤í¬íƒ‘ ìˆ˜ë¦¬", purpose: "ì—…ë¬´ ì¤‘ ì¥ë¹„ë¥¼ ì´ë™Â·ì •ë¦¬í•˜ëŠ” ê³¼ì •ì—ì„œ ì—…ë¬´ìš© ë°ìŠ¤í¬íƒ‘ì— ë¬¼ì´ ìœ ì…ë˜ì–´ ê³ ì¥ì´ ë°œìƒí•´ ìˆ˜ë¦¬ í•„ìš”", account: "ë†í˜‘ì€í–‰ / 517013-51-021555 / ì˜ˆê¸ˆì£¼ : ì„íƒœí™˜", note: "ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ, ì‚¬ì—…ì í˜„ê¸ˆì˜ìˆ˜ì¦ìœ¼ë¡œ ëŒ€ì²´" },
            { category: "ë¶€í’ˆêµ¬ë§¤", vendor: "ë™ì•„MCT", itemName: "ìë™í˜•head magìš© í•˜ë“œì›¨ì–´ ì œì‘ ê±´", purpose: "ìë™í˜• head mag í•˜ë“œì›¨ì–´ ì œì‘", account: "IMë±…í¬ 156-08-010722-1 (ì˜ˆê¸ˆì£¼:ë™ì•„MCT)", paymentMethod: "ê³„ì¢Œì´ì²´" },
            { category: "ë¶€í’ˆêµ¬ë§¤", vendor: "ì´êµ¬ìŠ¤", itemName: "ìë™í˜• head magìš© ë ˆì¼ êµ¬ë§¤ ê±´", purpose: "ìë™í˜• head magêµ¬ë™ë¶€ ë ˆì¼ 2ì°¨ ì¥ì°©", account: "í•˜ë‚˜ì€í–‰ 404-890002-31004 (ì˜ˆê¸ˆì£¼:í•œêµ­ì´êµ¬ìŠ¤)" },
            { category: "ì‹œí¸ì œì‘", vendor: "ë©”íŠ¸ë¡œí…Œí¬", itemName: "SECC 0.5 T 15 X 100 mm", purpose: "MPRT-CM Elekta ì¥ë¹„ ë¶€ì°©ë¬¼ì˜ ìë ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ìì„±ì²´ ì‹œí¸ ì œì‘", account: "IBKê¸°ì—…ì€í–‰ / 415-022977-01-016 / ì˜ˆê¸ˆì£¼ : (ì£¼)ë©”íŠ¸ë¡œí…Œí¬ì•ˆì–‘ê³µì¥" },
            { category: "ì™¸ì£¼ìš©ì—­", vendor: "ì…€ë¼", itemName: "EMC ë””ë²„ê¹…(ESD) ì™¸ì£¼ ìš©ì—­", purpose: "EMC ESD ì‹œí—˜ ë””ë²„ê¹…ì„ ìœ„í•œ ì „ë¬¸ê°€ í•„ìš”", account: "ì‹ í•œì€í–‰ / 110-295-060151 / ì˜ˆê¸ˆì£¼ : ê¹€ë‚˜ì˜" },
            { category: "ì¸ì¦ì‹œí—˜", vendor: "ë„´ì½”ì½”ë¦¬ì•„", itemName: "EMC Lab Shieldroom ì…íšŒ ì‹œí—˜(ì¶”ê°€ ì‹œí—˜)", purpose: "ì „ìíŒŒ ì í•©ì„± ì‹œí—˜ ì¤‘ Shieldroom ì‹œí—˜ ì¶”ê°€ ì§„í–‰", account: "ìš°ë¦¬ì€í–‰ / 398-092798-13-101 / ì˜ˆê¸ˆì£¼ : ì£¼ì‹íšŒì‚¬ë„´ì½”ì½”ë¦¬ì•„" },
            { category: "ì‹œí—˜ë¹„ìš©", vendor: "ìŠ¤íƒ ë‹¤ë“œë©", itemName: "Non-GLP ì„¸í¬ë…ì„± í…ŒìŠ¤íŠ¸", purpose: "MPRT-BA ì„¸í¬ë…ì„± ì‹œí—˜ ë¶ˆí•©ê²©ìœ¼ë¡œ ì¸í•œ non-GLP í…ŒìŠ¤íŠ¸ ì§„í–‰", account: "í•˜ë‚˜ì€í–‰ / 476-910028-45704 / ì˜ˆê¸ˆì£¼ : ì£¼ì‹íšŒì‚¬ ìŠ¤íƒ ë‹¤ë“œë©" },
            { category: "íŠ¹í—ˆ", vendor: "íŠ¹í—ˆë²•ì¸ ë¹„ì—˜í‹°", itemName: "BPP2021-0030AUD1 ë“±ë¡ë£Œ ì†¡ê¸ˆ", purpose: "í˜¸ì£¼íŠ¹í—ˆ ë“±ë¡ë£Œ ì†¡ê¸ˆ", account: "ìš°ë¦¬ì€í–‰ / 1005303954125 / ì˜ˆê¸ˆì£¼: íŠ¹í—ˆë²•ì¸ ë¹„ì—˜í‹°" },
            { category: "êµìœ¡", vendor: "ì¸í”„ëŸ°", itemName: "ê¹€ì˜í•œì˜ ì‹¤ì „ìë°” - ê¸°ë³¸í¸", purpose: "ê°ì²´ì§€í–¥ì— ëŒ€í•œ ì´í•´ í•„ìš” ì½”ë“œ ì¬ì‚¬ìš©ì„±, í™•ì¥ì„±, ëª¨ë“ˆí™”, ì¶”ìƒí™”, ìœ ì§€ë³´ìˆ˜ ë“±ì„ ìœ„í•œ í”„ë¡œê·¸ë˜ë° í•„ìš”", paymentMethod: "ê°œì¸ë²•ì¸ì¹´ë“œ" },
            { category: "êµìœ¡", vendor: "(ì£¼) ê°€ìš°ìŠ¤í…", itemName: "ì˜¤í˜ë¼ ì˜êµ¬ìì„ í•´ì„ ê´€ë ¨ êµìœ¡", purpose: "MPRT-HM ë° MPRT-CMì— í•„ìš”í•œ ì˜êµ¬ìì„ ì„¤ê³„ ë° í•´ì„ì„ ìœ„í•œ êµìœ¡", account: "ì‹ í•œì€í–‰ / 140-007-088210 / ì˜ˆê¸ˆì£¼ : (ì£¼) ê°€ìš°ìŠ¤í…" }
        ];

        const vendors = {
            'ê°€ìš°ìŠ¤í… (129-81-92585)': { account: 'ì‹ í•œì€í–‰ / 140-007-088210 / ì˜ˆê¸ˆì£¼: (ì£¼)ê°€ìš°ìŠ¤í…' },
            'ê±´ìš°ì‚°ì—… (816-88-00039)': { account: 'IBKê¸°ì—…ì€í–‰ / 523-041750-01-011 / ì˜ˆê¸ˆì£¼: (ì£¼)ê±´ìš°ì‚°ì—…' },
            'ë”ìŠ¤íƒ ë‹¤ë“œ (128-86-17026)': { account: 'í•˜ë‚˜ì€í–‰ / 476-910027-41304 / ì˜ˆê¸ˆì£¼: (ì£¼)ë”ìŠ¤íƒ ë‹¤ë“œ' },
            'ë§¤ë‹ˆì•„ì„œí”Œë¼ì´': { account: 'êµ­ë¯¼ì€í–‰ / 92030101750467 / ì˜ˆê¸ˆì£¼: ë§¤ë‹ˆì•„ì„œí”Œë¼ì´' },
            'ë©”íŠ¸ë¡œì‹¤ë¦¬ì½˜': { account: 'êµ­ë¯¼ì€í–‰ / 465701-04-054612 / ì˜ˆê¸ˆì£¼: ë©”íŠ¸ë¡œì‹¤ë¦¬ì½˜' },
            'ë©”íŠ¸ë¡œí…Œí¬ì•ˆì–‘ê³µì¥ (123-85-29627)': { account: 'IBKê¸°ì—…ì€í–‰ / 415-022977-01-016 / ì˜ˆê¸ˆì£¼: (ì£¼)ë©”íŠ¸ë¡œí…Œí¬ì•ˆì–‘ê³µì¥' },
            'ëª¨í„°114': { account: 'IBKê¸°ì—…ì€í–‰ / 13703900504018 / ì˜ˆê¸ˆì£¼: (ì£¼)ëª¨í„°114' },
            'ë¯¸ë¦¼ì”¨ìŠ¤ì½˜ (220-81-41768)': { account: 'IBKê¸°ì—…ì€í–‰ / 165-057893-04-011 / ì˜ˆê¸ˆì£¼: (ì£¼)ë¯¸ë¦¼ì”¨ìŠ¤ì½˜' },
            'ë°˜ë„NCTë ˆì´ì €': { account: 'IBKê¸°ì—…ì€í–‰ / 20702171901013 / ì˜ˆê¸ˆì£¼: ë°˜ë„NCTë ˆì´ì €' },
            'ë³€í˜¸ì‚¬ ì´ìš°ì§„ ë²•ë¥ ì‚¬ë¬´ì†Œ': { account: 'êµ­ë¯¼ì€í–‰ / 46570104055862 / ì˜ˆê¸ˆì£¼: ë³€í˜¸ì‚¬ ì´ìš°ì§„ ë²•ë¥ ì‚¬ë¬´ì†Œ' },
            'ë¸Œì´ì´ì—”ì§€': { account: 'ì¤‘ì†Œê¸°ì—…ì€í–‰ / 48702598204038 / ì˜ˆê¸ˆì£¼: ë¸Œì´ì´ì—”ì§€' },
            'ì„œì •í…Œí¬ (510-51-06712)': { account: 'IBKê¸°ì—…ì€í–‰ / 558-036762-04-029 / ì˜ˆê¸ˆì£¼: ì´ìŠ¹í˜„ ì„œì •í…Œí¬' },
            'ì…€íŒŒìŠ¤': { account: 'êµ­ë¯¼ì€í–‰ / 60240104074648 / ì˜ˆê¸ˆì£¼: ì…€íŒŒìŠ¤' },
            'ìŠ¤íƒ ë‹¤ë“œë© (253-86-03401)': { account: 'í•˜ë‚˜ì€í–‰ / 476-910028-45704 / ì˜ˆê¸ˆì£¼: ì£¼ì‹íšŒì‚¬ ìŠ¤íƒ ë‹¤ë“œë©' },
            'ì•„ì´ì„œë³´': { account: 'IBKê¸°ì—…ì€í–‰ / 18515007601016 / ì˜ˆê¸ˆì£¼: ì•„ì´ì„œë³´' },
            'ìš©ì‚°ì„¼íŠ¸ëŸ´íŒŒí¬ ë‹¨ì§€ ê´€ë¦¬ë‹¨': { account: 'ìš°ë¦¬ì€í–‰ / 1005804073595 / ì˜ˆê¸ˆì£¼: ìš©ì‚°ì„¼íŠ¸ëŸ´íŒŒí¬ ë‹¨ì§€ ê´€ë¦¬ë‹¨' },
            'ì¸ì•„ì˜¤ë¦¬ì—”íƒˆëª¨í„°': { account: 'ì‹ í•œì€í–‰ / 100030231529 / ì˜ˆê¸ˆì£¼: ì¸ì•„ì˜¤ë¦¬ì—”íƒˆëª¨í„°(ì£¼)' },
            'ì²­ì†ŒëŒ€ì¥ë¶€': { account: 'ê¸°ì—…ì€í–‰ / 00196758104019 / ì˜ˆê¸ˆì£¼: ì²­ì†ŒëŒ€ì¥ë¶€' },
            'ì¹´ë³¸ë©”ì´í¬ (411-81-75485)': { account: 'IBKê¸°ì—…ì€í–‰ / 191-096121-01-011 / ì˜ˆê¸ˆì£¼: ì£¼ì‹íšŒì‚¬ì¹´ë³¸ë©”ì´í¬' },
            'ì»´í“¨ì¡´': { account: 'ìš°ë¦¬ì€í–‰ / 1005101312721 / ì˜ˆê¸ˆì£¼: (ì£¼)ì»´í“¨ì¡´' },
            'ì¼€ì´ë¹„í•˜ë“œì›¨ì–´ë¶€ì‚°ì˜ì—…ì†Œ (274-87-01450)': { account: 'êµ­ë¯¼ì€í–‰ / 675001-04-280809 / ì˜ˆê¸ˆì£¼: (ì£¼)ì¼€ì´ë¹„í•˜ë“œì›¨ì–´ë¶€ì‚°ì˜ì—…ì†Œ' },
            'ì¼€ì´ì œë“œë© (569-88-01961)': { account: 'í•˜ë‚˜ì€í–‰ / 133-910083-18204 / ì˜ˆê¸ˆì£¼: ì£¼ì‹íšŒì‚¬ ì¼€ì´ì œë“œë©' },
            'ì½”ë ˆì´ì¦ˆí™€ë”©ìŠ¤': { account: 'KEBí•˜ë‚˜ì€í–‰ / 37591003038404 / ì˜ˆê¸ˆì£¼: ì£¼ì‹íšŒì‚¬ ì½”ë ˆì´ì¦ˆí™€ë”©ìŠ¤' },
            'íŠ¹í—ˆë²•ì¸ ë¹„ì—˜í‹° (752-86-01744)': { account: 'ìš°ë¦¬ì€í–‰ / 1005303954125 / ì˜ˆê¸ˆì£¼: íŠ¹í—ˆë²•ì¸ ë¹„ì—˜í‹°' },
            'í•˜ë‚˜ê¸°íš': { account: 'í•˜ë‚˜ì€í–‰ / 66791000864104 / ì˜ˆê¸ˆì£¼: (ì£¼)í•˜ë‚˜ê¸°íš' },
            'í•œêµ­ë Œíƒˆ': { account: 'ì‚°ì—…ì€í–‰ / 02203006736311 / ì˜ˆê¸ˆì£¼: í•œêµ­ë Œíƒˆ' },
            'í•œêµ­í”Œëœí…Œí¬ (550-88-00274)': { account: 'IBKê¸°ì—…ì€í–‰ / 378-140954-01-016 / ì˜ˆê¸ˆì£¼: í•œêµ­í”Œëœí…Œí¬' },
            'í•œìš¸ì´ì—”ì§€ (566-87-01795)': { account: 'IBKê¸°ì—…ì€í–‰ / 955-018919-01-012 / ì˜ˆê¸ˆì£¼: ì£¼ì‹íšŒì‚¬ í•œìš¸ì´ì—”ì§€' },
            'í˜„ëŒ€ì‹¤ë¦¬ì½˜ (136-81-31247)': { account: 'êµ­ë¯¼ì€í–‰ / 253-25-0013-096 / ì˜ˆê¸ˆì£¼: (ì£¼)í˜„ëŒ€ì‹¤ë¦¬ì½˜' },
            'ì´êµ¬ìŠ¤': { account: 'í•˜ë‚˜ì€í–‰ 404-890002-31004 (ì˜ˆê¸ˆì£¼:í•œêµ­ì´êµ¬ìŠ¤)' },
            'ë„´ì½”ì½”ë¦¬ì•„': { account: 'ìš°ë¦¬ì€í–‰ / 398-092798-13-101 / ì˜ˆê¸ˆì£¼ : ì£¼ì‹íšŒì‚¬ë„´ì½”ì½”ë¦¬ì•„' },
            'ì…€ë¼': { account: 'ì‹ í•œì€í–‰ / 110-295-060151 / ì˜ˆê¸ˆì£¼ : ê¹€ë‚˜ì˜' },
            'ê²½ê¸°FA': { account: 'ê¸°ì—…ì€í–‰ 471-036753-01-026 / ê²½ê¸°FA' },
            'ì„œìš¸ì•„ì‚°ë³‘ì› ë°•ê¸°í™ ë°•ì‚¬': { account: 'ì‹ í•œì€í–‰ / 254-910471-70707 / ì˜ˆê¸ˆì£¼ : ë°•ê¸°í™' }
        };

        // [ìˆ˜ì •] ì´ë¯¸ì§€ì— ë§ì¶° ê²°ì œìˆ˜ë‹¨ ì˜µì…˜ ì—…ë°ì´íŠ¸
        const paymentMethodOptions = [
            'ì´ì²´(ìš´ì˜ë¹„)', 'ì´ì²´(ë°ì´í„°3ì°¨)', 'ì´ì²´(KARA)', 'ê°œì¸ë²•ì¸ì¹´ë“œ', 'SWì¹´ë“œ', 'ë‹¤ê³¼ì¹´ë“œ', 'ì‚¬ë¬´ì¡ë¹„ì¹´ë“œ'
        ];

        // [ìˆ˜ì •] ê³µí†µ í•„ë“œ: ê±°ë˜ì²˜ ë¼ë²¨ ë³€ê²½
        const BASE_COMMON_FIELDS = [
            { id: 'vendor', label: 'ê±°ë˜ì²˜ëª… ë° ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸', example: 'ì£¼ì‹íšŒì‚¬ ê°€ë‚˜ë‹¤ / 123-45-67890' },
            { id: 'paymentMethod', label: 'ê²°ì œìˆ˜ë‹¨', type: 'select', options: paymentMethodOptions },
            { id: 'account', label: 'ê±°ë˜ì²˜ ê³„ì¢Œ ì •ë³´', example: 'êµ­ë¯¼ì€í–‰ / 465701-04-054612 / ì˜ˆê¸ˆì£¼ : OOO' },
            { id: 'purpose', label: 'êµ¬ë§¤ ëª©ì ', example: 'êµ¬ë§¤ ëª©ì  ë‚´ìš© ê¸°ì¬' },
        ];

        const DEFAULT_PINNED_IDS = BASE_COMMON_FIELDS.map(f => f.id);

        // [ìˆ˜ì •] ê°œë³„ í•„ë“œ: ê´€ë ¨ ê³¼ì œëª… ì¶”ê°€ ë° ë¼ë²¨ ì—…ë°ì´íŠ¸
        const FIELD = {
            itemName: { id: 'itemName', label: 'í’ˆëª©ëª…', example: 'ì—…ë¬´ìš© ëª¨ë‹ˆí„° (ì œì¡°ì‚¬: ì‚¼ì„±ì „ì)' },
            spec: { id: 'spec', label: 'ê·œê²©/ì„¤ëª…/ìš©ì—­ë‚´ìš©/ì§€ì¶œë‚´ìš©', example: 'ê°„ëµí•œ ì„¸ë¶€ ë‚´ìš©' },
            qty: { id: 'qty', label: 'ìˆ˜ëŸ‰', example: '2, 4' },
            unitPrice: { id: 'unitPrice', label: 'ë‹¨ê°€(ì™¸í™”ì¸ ê²½ìš° í†µí™” ê¸°ì¬)', example: '22,000,000 ì› / 10 USD' },
            amount: { id: 'amount', label: 'ì´ ê¸ˆì•¡(ë¶€ê°€ì„¸ í¬í•¨)', example: '44,000,000 ì› / 40 USD' },
            date: { id: 'date', label: 'êµ¬ë§¤ì¼ì', example: '2025. 11. 19.' },
            note: { id: 'note', label: 'ê¸°íƒ€ì‚¬í•­(í•„ìš” ì‹œ ì‘ì„±)', example: 'íŠ¹ë³„ ìš”ì²­ì‚¬í•­ ë˜ëŠ” ë¶€ê°€ ì •ë³´' },
            user: { id: 'user', label: 'ì‚¬ìš©ì/ì‚¬ìš©ë¶€ì„œ', example: 'ì‚¬ìš©í•  ì„ì§ì›, ë¶€ì„œ, ê³µìš© ë“±' },
            manufacturer: { id: 'manufacturer', label: 'ì œì¡°ì‚¬', example: 'í•œì„±ì»´í“¨í„°, MS, ì¶œíŒì‚¬ ë“±' },
            paymentTerms: { id: 'paymentTerms', label: 'ì§€ê¸‰ ì¡°ê±´(í•„ìš” ì‹œ ì‘ì„±)', example: '1) ê³„ì•½ê¸ˆ: 30% || 2) ì”ê¸ˆ: 70%' },

            // [ì¶”ê°€] ê´€ë ¨ ê³¼ì œëª… (ì—°êµ¬ë¹„ ì´ì²´ ì‹œ í•„ìˆ˜)
            relatedTask: { id: 'relatedTask', label: 'ê´€ë ¨ ê³¼ì œëª… (*ì—°êµ¬ë¹„ ê³„ì¢Œ ì´ì²´ ì‹œ ê¸°ì¬)', example: 'ë°©ì‚¬ì„ ìœµë³µí•©ì‚°ì—…ì§€ì› ì‚¬ì—… ì§€ì›ê¸ˆ' },

            // ê¸°ì¡´ í•„ë“œë“¤ (ë‹¤ë¥¸ ì–‘ì‹ìš© ìœ ì§€)
            isRecurring: { id: 'isRecurring', label: 'ì •ê¸°ê²°ì œ ì—¬ë¶€', example: 'ì¼ì‹œë‚© / ë§¤ë…„ / ë§¤ì›” ë“±' },
            recurringPeriod: { id: 'recurringPeriod', label: 'ìë™ ê²°ì œ ê¸°ê°„', example: 'ë¬´ê¸°í•œ, 2023.3.14 ~ 2024.3.14' },
            recurringDate: { id: 'recurringDate', label: 'ìë™ ê²°ì œì¼', example: 'ë§¤ë‹¬ 10ì¼, ë§¤ë…„ 3ì›” ë‘˜ì§¸ ì£¼ ë“±' },
            place: { id: 'place', label: 'ì¥ì†Œ/êµìœ¡ì¥ì†Œ', example: 'ì˜¨ë¼ì¸, ë¼ë±ì…€ íšŒì˜ì‹¤ ë“±' },
            attendees: { id: 'attendees', label: 'ì°¸ì„ì/êµìœ¡ëŒ€ìƒ', example: 'ëŒ€ìƒ ì§ì›, ë¶€ì„œ, ì „ ì„ì§ì› ë“±' },
            service: { id: 'service', label: 'ìš©ì—­ëª…', example: 'ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ ì™¸ì£¼ ìš©ì—­' },
            periodFrom: { id: 'periodFrom', label: 'ê¸°ê°„(ì‹œì‘)', example: '2024. 6. 18.' },
            periodTo: { id: 'periodTo', label: 'ê¸°ê°„(ì¢…ë£Œ)', example: '2024. 7. 18.' },
            course: { id: 'course', label: 'êµìœ¡ëª…ì¹­', example: 'ë°ì´í„°ë¶„ì„ ì‹¤ë¬´ ê°•ì˜' },
            provider: { id: 'provider', label: 'ê°•ì‚¬/êµìœ¡ê¸°ê´€', example: 'í™ê¸¸ë™/íŒ¨ìŠ¤íŠ¸ìº í¼ìŠ¤' },
            license: { id: 'license', label: 'ì œí’ˆ/ë¼ì´ì„ ìŠ¤ëª…', example: 'ë¯¸ë¡œë³´ë“œ ë¹„ì¦ˆë‹ˆìŠ¤ í”Œëœ' },
            seats: { id: 'seats', label: 'ë¼ì´ì„ ìŠ¤ ìˆ˜', example: '2, 4' },
            origin: { id: 'origin', label: 'ì¶œë°œì§€', example: 'íšŒì‚¬' },
            destination: { id: 'destination', label: 'ë„ì°©ì§€', example: 'ê°•ì›ëŒ€ë³‘ì›' },
            tripObjective: { id: 'tripObjective', label: 'ì¶œì¥ ëª©ì ', example: 'ì˜ë£Œê¸°ê¸° ì„¤ì¹˜' },
            proof: { id: 'proof', label: 'ì¦ë¹™ìë£Œ', example: 'ë„¤ì´ë²„ ê¸¸ì°¾ê¸° ìº¡ì²˜ ì²¨ë¶€' },
            expenseTransit: { id: 'expenseTransit', label: 'êµí†µë¹„', example: 'í•­ê³µë£Œ, ê¸°ì°¨ë£Œ ë“± ì´ ê¸ˆì•¡' },
            expenseLodging: { id: 'expenseLodging', label: 'ìˆ™ë°•ë¹„', example: 'ìˆ™ë°•ë¹„ ì´ ê¸ˆì•¡' },
            expenseMeal: { id: 'expenseMeal', label: 'ì‹ë¹„', example: 'ì—…ë¬´ ê´€ë ¨ ì‹ì‚¬ ë¹„ìš©' },
            expenseOther: { id: 'expenseOther', label: 'ê¸°íƒ€ë¹„ìš©', example: 'ê¸°íƒ€ ë¹„ìš© ì´ ê¸ˆì•¡' },
            ipMgmtNo: { id: 'ipMgmtNo', label: 'íŠ¹í—ˆ ê´€ë¦¬ë²ˆí˜¸', example: 'BPP2021-0030US' },
            invoiceNo: { id: 'invoiceNo', label: 'ì²­êµ¬ì„œ ë²ˆí˜¸', example: 'SPS24-2336' },
        };

        const T = (title, ...fields) => ({ title, fields: [...BASE_COMMON_FIELDS, ...Object.values(FIELD).filter(f => fields.includes(f))] });

        // [ìˆ˜ì •] ì¼ë°˜ ì§€ì¶œí’ˆì˜ì„œ: ìƒˆ ì–‘ì‹ì— ë§ì¶° relatedTask ì¶”ê°€í•˜ê³  ì •ê¸°ê²°ì œ ê´€ë ¨ ì œì™¸
        const formTemplates = {
            'general_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì¼ë°˜', FIELD.itemName, FIELD.unitPrice, FIELD.qty, FIELD.amount, FIELD.date, FIELD.paymentTerms, FIELD.user, FIELD.relatedTask, FIELD.note),

            // ê¸°ì¡´ í…œí”Œë¦¿ ìœ ì§€
            'meeting_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì‚¬ë‚´ ì‚¬ì™¸ íšŒì˜ë¹„', FIELD.itemName, FIELD.amount, FIELD.user, FIELD.note),
            'outsourcing_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì™¸ì£¼ìš©ì—­', FIELD.service, FIELD.periodFrom, FIELD.periodTo, FIELD.spec, FIELD.user, FIELD.amount, FIELD.isRecurring, FIELD.recurringPeriod, FIELD.recurringDate, FIELD.paymentTerms, FIELD.note),
            'education_expense': T('ì§€ì¶œí’ˆì˜ì„œ - êµìœ¡ë¹„', FIELD.course, FIELD.provider, FIELD.periodFrom, FIELD.periodTo, FIELD.place, FIELD.attendees, FIELD.amount, FIELD.relatedTask, FIELD.note),
            'software_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì†Œí”„íŠ¸ì›¨ì–´', FIELD.license, FIELD.unitPrice, FIELD.seats, FIELD.manufacturer, FIELD.amount, FIELD.isRecurring, FIELD.recurringPeriod, FIELD.recurringDate, FIELD.date, FIELD.paymentTerms, FIELD.user, FIELD.note),
            'ip_expense': T('ì§€ì¶œí’ˆì˜ì„œ - ì§€ì‹ì¬ì‚°ê¶Œ', FIELD.spec, FIELD.ipMgmtNo, FIELD.invoiceNo, FIELD.amount, FIELD.paymentTerms, FIELD.note),
            'travel_expense_claim': T('ì§€ì¶œìŠ¹ì¸ìš”ì²­ì„œ - êµí†µì—¬ë¹„ ì²­êµ¬', FIELD.date, FIELD.origin, FIELD.destination, FIELD.tripObjective, FIELD.amount, FIELD.proof),
            'business_trip_report': T('ì¶œì¥í’ˆì˜ì„œ - ì§€ì¶œì •ë³´', FIELD.tripObjective, FIELD.place, FIELD.expenseTransit, FIELD.expenseLodging, FIELD.expenseMeal, FIELD.expenseOther, FIELD.amount, FIELD.note),
        };

        let items = [{}];
        let currentFormType = 'general_expense';
        let hiddenFields = [];
        let pinnedFields = [...DEFAULT_PINNED_IDS];
        let commonData = {};

        const expandableContainer = document.querySelector('.expandable-width-container');
        const commonInputsContainer = document.getElementById('common-inputs-container');
        const itemsContainer = document.getElementById('items-container');
        const addItemBtn = document.getElementById('add-item-btn');
        const applyCommonBtn = document.getElementById('apply-common-btn');
        const copyBtn = document.getElementById('copyBtn');
        const formTypeSelector = document.getElementById('masterFormType');
        const resetBtn = document.getElementById('reset-btn');

        applyCommonBtn.textContent = '[â†“] ê³µí†µ ì •ë³´ ì¼ê´„ ì ìš©';

        const saveState = () => {
            localStorage.setItem('wehagoFormData', JSON.stringify({ items, currentFormType, hiddenFields, pinnedFields, commonData }));
        };

        const loadState = () => {
            try {
                const savedState = localStorage.getItem('wehagoFormData');
                if (savedState) {
                    const data = JSON.parse(savedState);
                    items = data.items && data.items.length > 0 ? data.items : [{}];
                    currentFormType = data.currentFormType || 'general_expense';
                    hiddenFields = data.hiddenFields || [];
                    pinnedFields = data.pinnedFields || [...DEFAULT_PINNED_IDS];
                    commonData = data.commonData || {};
                    formTypeSelector.value = currentFormType;
                }
            } catch (e) { console.error("Could not load state", e); }
        };

        const adjustContainerWidth = () => {
            const section = expandableContainer.querySelector('.section');
            const bodyPadding = parseFloat(getComputedStyle(document.body).paddingLeft) * 2;
            const sectionPadding = parseFloat(getComputedStyle(section).paddingLeft) * 2;
            const maxAllowedWidth = window.innerWidth - bodyPadding;
            const cardWidth = 320;
            const cardGap = 1.5 * 16;
            const defaultWidth = 900;
            let requiredContainerWidth = (items.length <= 1) ? defaultWidth : ((items.length * (cardWidth + cardGap)) - cardGap) + sectionPadding;
            const finalContainerWidth = Math.min(requiredContainerWidth, maxAllowedWidth);
            expandableContainer.style.maxWidth = `${Math.max(finalContainerWidth, defaultWidth)}px`;
            const actualContentWidth = (items.length * cardWidth) + (Math.max(0, items.length - 1) * cardGap);
            itemsContainer.style.width = items.length > 1 ? `${actualContentWidth}px` : '100%';
        };

        function render() {
            const template = formTemplates[currentFormType];
            const allFields = template.fields;

            // [ìˆ˜ì •] ì´ë¯¸ì§€ ìˆœì„œì™€ ë™ì¼í•˜ê²Œ ì •ë ¬ (í’ˆëª© -> ë‹¨ê°€ -> ìˆ˜ëŸ‰ -> ê¸ˆì•¡ -> ë‚ ì§œ ...)
            const FIELD_ORDER = [
                'itemName',
                'unitPrice',
                'qty',
                'amount',
                'date',
                'paymentTerms',
                'user',
                'paymentMethod',
                'vendor',
                'account',
                'relatedTask', // [ì¶”ê°€] ê´€ë ¨ ê³¼ì œëª… ìœ„ì¹˜
                'purpose',
                'note',

                // ê¸°íƒ€ í•„ë“œë“¤ (ë‹¤ë¥¸ ì–‘ì‹ìš©)
                'service', 'course', 'license', 'tripObjective',
                'spec', 'periodFrom', 'periodTo',
                'isRecurring', 'recurringPeriod', 'recurringDate',
                'origin', 'destination', 'place', 'attendees', 'provider', 'manufacturer',
                'ipMgmtNo', 'invoiceNo', 'proof', 'seats'
            ];

            const orderIndex = (id) => {
                const i = FIELD_ORDER.indexOf(id);
                return i === -1 ? 1000 + allFields.findIndex(f => f.id === id) : i;
            };
            const sortFields = (arr) => arr.slice().sort((a, b) => orderIndex(a.id) - orderIndex(b.id));

            const visiblePinnedFields = sortFields(allFields.filter(f => pinnedFields.includes(f.id) && !hiddenFields.includes(f.id)));
            commonInputsContainer.innerHTML = visiblePinnedFields.map(field => {
                const value = commonData[field.id] || '';
                let inputHtml = `<div>
                        <div class="label-wrapper">
                            <label for="common_${field.id}">${field.label}</label>
                            <div class="label-icons">
                                <button class="icon-btn pin-btn" data-pin-action="unpin" data-field-id="${field.id}" title="ê°œë³„ í•­ëª©ìœ¼ë¡œ ë³€ê²½">ğŸ”“</button>
                                <button class="icon-btn hide-btn" tabindex="-1" data-field-id="${field.id}" title="í•­ëª© ìˆ¨ê¸°ê¸°">Ã—</button>
                            </div>
                        </div>`;
                if (field.id === 'vendor') {
                    // ê°’ì´ ì¡´ì¬í•˜ì§€ë§Œ ë¯¸ë¦¬ ì •ì˜ëœ ê±°ë˜ì²˜ ëª©ë¡(vendors)ì— ì—†ëŠ” ê²½ìš° -> ì§ì ‘ ì…ë ¥ ëª¨ë“œ(Input)
                    const isCustomVendor = value && !vendors[value];

                    if (isCustomVendor) {
                        inputHtml += `
                            <div style="display:flex; gap:0.5rem; align-items: center;">
                                <input type="text" id="common_${field.id}" value="${value}" placeholder="ê±°ë˜ì²˜ëª… ì§ì ‘ ì…ë ¥" style="flex:1;">
                                <button class="button button-secondary vendor-toggle-btn" data-action="to-list" style="padding:0.75rem; font-size:0.8rem; white-space:nowrap;">
                                    ğŸ“‹ ëª©ë¡ ì„ íƒ
                                </button>
                            </div>`;
                    } else {
                        // ëª©ë¡ì— ìˆê±°ë‚˜ ê°’ì´ ì—†ëŠ” ê²½ìš° -> ì„ íƒ ëª¨ë“œ(Select)
                        const optionsHtml = Object.keys(vendors).map(k => `<option value="${k}" ${value === k ? 'selected' : ''}>${k}</option>`).join('');
                        inputHtml += `
                            <select id="common_${field.id}">
                                <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                                ${optionsHtml}
                                <option value="__DIRECT__" style="color: var(--primary-color); font-weight:bold;">+ ì§ì ‘ ì…ë ¥ (ì‹ ê·œ ê±°ë˜ì²˜)</option>
                            </select>`;
                    }

                } else if (field.type === 'select') {
                    const optionsHtml = field.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    inputHtml += `<select id="common_${field.id}"><option value="">-- ì„ íƒ --</option>${optionsHtml}</select>`;
                } else {
                    inputHtml += `<input type="text" id="common_${field.id}" value="${value}" placeholder="${field.example || ''}">`;
                }
                return inputHtml + `</div>`;
            }).join('');

            const allVisibleFields = sortFields(allFields.filter(f => !hiddenFields.includes(f.id)));
            itemsContainer.innerHTML = items.map((itemData, index) => {
                const itemFieldsHtml = allVisibleFields.map(field => {
                    const isPinned = pinnedFields.includes(field.id);
                    const value = itemData[field.id] || '';
                    const uniqueId = `${field.id}_${index}`;

                    let iconsHtml = isPinned
                        ? `<button class="icon-btn lock-icon" title="ê³µí†µ í•­ëª©ì…ë‹ˆë‹¤. ìœ„ì—ì„œ ì¼ê´„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">ğŸ”’</button>`
                        : `<button class="icon-btn pin-btn" data-pin-action="pin" data-field-id="${field.id}" title="ê³µí†µ í•­ëª©ìœ¼ë¡œ ê³ ì •">ğŸ“Œ</button>
                                <button class="icon-btn hide-btn" tabindex="-1" data-field-id="${field.id}" title="í•­ëª© ìˆ¨ê¸°ê¸°">Ã—</button>`;

                    let fieldHtml = `<div>
                            <div class="label-wrapper">
                                <label for="${uniqueId}">${field.label}</label>
                                <div class="label-icons">${iconsHtml}</div>
                            </div>`;

                    if (field.type === 'select') {
                        if (field.id === 'paymentMethod') {
                            fieldHtml += `<input type="text" id="${uniqueId}" value="${value}" placeholder="ì§ì ‘ ì…ë ¥...">`;
                        } else {
                            const optionsHtml = field.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('');
                            fieldHtml += `<select id="${uniqueId}"><option value="">-- ì„ íƒ --</option>${optionsHtml}</select>`;
                        }
                    } else {
                        fieldHtml += `<input type="text" id="${uniqueId}" value="${value}" placeholder="${field.example || ''}">`;
                    }

                    return fieldHtml + `</div>`;
                }).join('');

                return `
                        <div class="item-card" data-index="${index}">
                            <div class="item-header"><h3>í•­ëª© ${index + 1}</h3>${items.length > 1 ? '<button class="remove-item-btn" tabindex="-1" title="í•­ëª© ì‚­ì œ">Ã—</button>' : ''}</div>
                            <div class="item-fields-container">${itemFieldsHtml}</div>
                        </div>`;
            }).join('');

            const hiddenCommonFields = allFields.filter(f => hiddenFields.includes(f.id) && pinnedFields.includes(f.id));
            const hiddenItemOnlyFields = allFields.filter(f => hiddenFields.includes(f.id) && !pinnedFields.includes(f.id));
            renderRestoreSection('common-restore-section', hiddenCommonFields);
            renderRestoreSection('item-restore-section', hiddenItemOnlyFields);

            if (items.length === 1) itemsContainer.querySelector('.item-card')?.classList.add('single-item');
            adjustContainerWidth();
            saveState();
        }

        // --- AI ê³ ê¸‰ ì„¤ì • UI ì œì–´ í•¨ìˆ˜ ---
        function toggleSplitOptions() {
            const mode = document.querySelector('input[name="aiMode"]:checked').value;
            const detailOptions = document.getElementById('split-detail-options');
            if (mode === 'split') {
                detailOptions.style.display = 'block';
            } else {
                detailOptions.style.display = 'none';
            }
        }

        function renderRestoreSection(sectionId, hiddenFields) {
            const sectionEl = document.getElementById(sectionId);
            if (hiddenFields.length > 0) {
                sectionEl.style.display = 'block';
                sectionEl.innerHTML = `
                        <h4>[+] ë³µì›í•  í•­ëª©ì„ í´ë¦­í•˜ì„¸ìš”</h4>
                        <div class="restore-list">${hiddenFields.map(f => `<button class="restore-btn" data-field-id="${f.id}">${f.label}</button>`).join('')}</div>`;
            } else {
                sectionEl.style.display = 'none';
            }
        }

        function handlePinClick(e) {
            const btn = e.target.closest('.pin-btn');
            if (!btn) return;

            const fieldId = btn.dataset.fieldId;
            const action = btn.dataset.pinAction;

            if (action === 'pin') {
                if (!pinnedFields.includes(fieldId)) pinnedFields.push(fieldId);
                const valueFromFirstItem = items.length > 0 ? (items[0][fieldId] || '') : '';
                commonData[fieldId] = valueFromFirstItem;
                items.forEach(item => item[fieldId] = valueFromFirstItem);
            } else if (action === 'unpin') {
                const index = pinnedFields.indexOf(fieldId);
                if (index > -1) pinnedFields.splice(index, 1);
            }
            render();
        }

        function handleIconClick(e) {
            const btn = e.target.closest('.hide-btn');
            if (!btn) return;
            const fieldId = btn.dataset.fieldId;
            if (!hiddenFields.includes(fieldId)) hiddenFields.push(fieldId);
            render();
        }

        function handleRestoreClick(e) {
            const restoreBtn = e.target.closest('.restore-btn');
            if (restoreBtn) {
                const fieldId = restoreBtn.dataset.fieldId;
                const index = hiddenFields.indexOf(fieldId);
                if (index > -1) {
                    hiddenFields.splice(index, 1);
                    render();
                }
            }
        }

        document.getElementById('common-restore-section').addEventListener('click', handleRestoreClick);
        document.getElementById('item-restore-section').addEventListener('click', handleRestoreClick);

        commonInputsContainer.addEventListener('click', (e) => {
            handleIconClick(e);
            handlePinClick(e);
        });
        itemsContainer.addEventListener('click', (e) => {
            handleIconClick(e);
            handlePinClick(e);
            if (e.target.classList.contains('remove-item-btn')) {
                items.splice(e.target.closest('.item-card').dataset.index, 1);
                if (items.length === 0) items.push({});
                render();
            }
        });

        // [ìˆ˜ì •] ê³µí†µ ì •ë³´ ì…ë ¥ ë¦¬ìŠ¤ë„ˆ (ê±°ë˜ì²˜ ëª¨ë“œ + ê¸ˆì•¡ í¬ë§·íŒ… ì¶”ê°€)
        commonInputsContainer.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                const fieldId = e.target.id.replace('common_', '');
                let value = e.target.value;

                // [ê¸°ì¡´ ì½”ë“œ]
                // let value = e.target.value;

                // â–¼â–¼â–¼ [ì—¬ê¸°ì„œë¶€í„° ë¶™ì—¬ë„£ê¸°] â–¼â–¼â–¼
                // [ì¶”ê°€] ê²°ì œìˆ˜ë‹¨ì— ë”°ë¥¸ ê´€ë ¨ ê³¼ì œëª… ìë™ ë§¤ì¹­
                if (fieldId === 'paymentMethod') {
                    let autoTaskName = '';
                    if (value.includes('KARA')) {
                        autoTaskName = 'ë°©ì‚¬ì„  ìœµë³µí•© ì‚°ì—… ì§€ì›ì‚¬ì—…';
                    } else if (value.includes('ë°ì´í„°')) {
                        autoTaskName = 'ë°ì´í„° í™œìš© ì˜ë£Œ ê±´ê°• ì‚¬ì—…';
                    }
                    
                    if (autoTaskName) {
                        commonData['relatedTask'] = autoTaskName;
                        // í™”ë©´ ì¦‰ì‹œ ë°˜ì˜
                        const taskInput = document.getElementById('common_relatedTask');
                        if (taskInput) taskInput.value = autoTaskName;
                    }
                }
                // â–²â–²â–² [ì—¬ê¸°ê¹Œì§€ ë¶™ì—¬ë„£ê¸°] â–²â–²â–²

                // [ê¸°ì¡´ ì½”ë“œ]
                // // [ì‹ ê·œ] ê¸ˆì•¡/ë‹¨ê°€ í•„ë“œì¼ ê²½ìš° ìë™ í¬ë§·íŒ… ì ìš©
                
                // [ì‹ ê·œ] ê¸ˆì•¡/ë‹¨ê°€ í•„ë“œì¼ ê²½ìš° ìë™ í¬ë§·íŒ… ì ìš©
                if (fieldId === 'amount' || fieldId === 'unitPrice') {
                    value = formatSmartCurrency(value);
                    e.target.value = value; // í™”ë©´ì— ì½¤ë§ˆ ë°˜ì˜
                }

                // [ì‹ ê·œ] ê±°ë˜ì²˜ Selectì—ì„œ "ì§ì ‘ ì…ë ¥"ì„ ì„ íƒí•œ ê²½ìš°
                if (fieldId === 'vendor' && value === '__DIRECT__') {
                    commonData['vendor'] = " ";
                    saveState();
                    render();
                    setTimeout(() => {
                        const inputEl = document.getElementById('common_vendor');
                        if (inputEl) {
                            inputEl.value = "";
                            inputEl.focus();
                        }
                    }, 50);
                    return;
                }

                commonData[fieldId] = value;

                if (fieldId === 'vendor' && vendors[value]) {
                    commonData['account'] = vendors[value].account || '';
                    const accountInput = document.getElementById('common_account');
                    if (accountInput) accountInput.value = commonData['account'];
                }

                saveState();
            }
        });



        // [ì¶”ê°€] ê±°ë˜ì²˜ ëª¨ë“œ ì „í™˜ (ëª©ë¡ â†” ì§ì ‘ì…ë ¥) ì²˜ë¦¬ ë¦¬ìŠ¤ë„ˆ
        commonInputsContainer.addEventListener('click', (e) => {
            // ê¸°ì¡´ í•€/ìˆ¨ê¹€ ë²„íŠ¼ ë¡œì§ ìœ ì§€ (ìƒë‹¨ì— ìˆìŒ)
            handleIconClick(e);
            handlePinClick(e);

            // [ì‹ ê·œ] "ëª©ë¡ ì„ íƒ" ë²„íŠ¼ í´ë¦­ ì‹œ
            if (e.target.classList.contains('vendor-toggle-btn')) {
                const action = e.target.dataset.action;
                if (action === 'to-list') {
                    commonData['vendor'] = ''; // ê°’ì„ ë¹„ì›Œì„œ Select ëª¨ë“œë¡œ ë³µê·€
                    saveState();
                    render();
                }
            }
        });

        // [ìˆ˜ì •] ê¸°ì¡´ input ë¦¬ìŠ¤ë„ˆì— "ì§ì ‘ ì…ë ¥" ì„ íƒ ê°ì§€ ë¡œì§ ì¶”ê°€
        commonInputsContainer.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                const fieldId = e.target.id.replace('common_', '');
                let value = e.target.value;

                // [ì‹ ê·œ] ê±°ë˜ì²˜ Selectì—ì„œ "ì§ì ‘ ì…ë ¥"ì„ ì„ íƒí•œ ê²½ìš°
                if (fieldId === 'vendor' && value === '__DIRECT__') {
                    // ì„ì‹œ í…ìŠ¤íŠ¸ë¥¼ ë„£ì–´ Input ëª¨ë“œë¡œ ê°•ì œ ì „í™˜ (ë‹¤ìŒ ë Œë”ë§ ì‹œ ì ìš©ë¨)
                    commonData['vendor'] = " "; // ê³µë°±ì„ ë„£ì–´ ê°’ì´ ìˆëŠ” ê²ƒìœ¼ë¡œ ì¸ì‹ì‹œí‚´
                    saveState();
                    render();

                    // ë Œë”ë§ í›„ í¬ì»¤ìŠ¤ ì´ë™ ë° ê°’ ì´ˆê¸°í™”
                    setTimeout(() => {
                        const inputEl = document.getElementById('common_vendor');
                        if (inputEl) {
                            inputEl.value = ""; // ê³µë°± ì œê±°
                            inputEl.focus();
                        }
                    }, 50);
                    return;
                }

                commonData[fieldId] = value;

                // ê±°ë˜ì²˜ ì„ íƒ ì‹œ ê³„ì¢Œ ìë™ ì…ë ¥ (ì§ì ‘ ì…ë ¥ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
                if (fieldId === 'vendor' && vendors[value]) {
                    commonData['account'] = vendors[value].account || '';
                    const accountInput = document.getElementById('common_account');
                    if (accountInput) accountInput.value = commonData['account'];
                }

                saveState();
            }
        });







        applyCommonBtn.addEventListener('click', () => {
            items.forEach(item => {
                pinnedFields.forEach(fieldId => {
                    item[fieldId] = commonData[fieldId] || '';
                });
            });
            render();
            items.forEach((_, index) => {
                pinnedFields.forEach(fieldId => {
                    const element = document.getElementById(`${fieldId}_${index}`);
                    if (element) {
                        element.classList.add('highlight');
                        setTimeout(() => element.classList.remove('highlight'), 1200);
                    }
                });
            });
        });

        addItemBtn.addEventListener('click', () => {
            const lastItem = items[items.length - 1] || {};
            const newItem = {};
            const templateFields = formTemplates[currentFormType].fields;

            templateFields.forEach(field => {
                if (pinnedFields.includes(field.id)) {
                    newItem[field.id] = commonData[field.id] || '';
                } else if (lastItem[field.id] !== undefined) {
                    newItem[field.id] = lastItem[field.id];
                }
            });
            items.push(newItem);

            render();
            const newCard = itemsContainer.lastElementChild;
            if (newCard) {
                newCard.querySelector('input, select')?.focus();
                newCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        });

        // [ìˆ˜ì •] ì„¸ë¶€ í•­ëª© ì…ë ¥ ë¦¬ìŠ¤ë„ˆ (ê¸ˆì•¡ í¬ë§·íŒ… ì¶”ê°€)
        itemsContainer.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                const index = e.target.closest('.item-card').dataset.index;
                const fieldId = e.target.id.split('_')[0];
                let value = e.target.value;

                // [ì‹ ê·œ] ê¸ˆì•¡/ë‹¨ê°€ í•„ë“œì¼ ê²½ìš° ìë™ í¬ë§·íŒ… ì ìš©
                if (fieldId === 'amount' || fieldId === 'unitPrice') {
                    value = formatSmartCurrency(value);
                    e.target.value = value; // í™”ë©´ì— ì½¤ë§ˆ ë°˜ì˜
                }

                items[index][fieldId] = value;
                saveState();
            }
        });

        formTypeSelector.addEventListener('change', (e) => {
            if (confirm('ì–‘ì‹ì„ ë³€ê²½í•˜ë©´ í˜„ì¬ ì‘ì„±ëœ í•­ëª©ê³¼ ëª¨ë“  ì„¤ì •ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                currentFormType = e.target.value;
                items = [{}];
                hiddenFields = [];
                pinnedFields = [...DEFAULT_PINNED_IDS];
                commonData = {};
                pinnedFields.forEach(fieldId => {
                    items[0][fieldId] = commonData[fieldId] || '';
                });
                localStorage.removeItem('wehagoFormData');
                render();
            } else {
                e.target.value = currentFormType;
            }
        });

        resetBtn.addEventListener('click', () => {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  í•­ëª©ê³¼ ì„¤ì •ì„ ì§€ìš°ê³  ìƒˆë¡œ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                items = [{}];
                hiddenFields = [];
                pinnedFields = [...DEFAULT_PINNED_IDS];
                commonData = {};
                pinnedFields.forEach(fieldId => {
                    items[0][fieldId] = commonData[fieldId] || '';
                });
                localStorage.removeItem('wehagoFormData');
                render();
            }
        });


        // -----------------------------------------------------------
        // [ë³µêµ¬ ì™„ë£Œ] ìµœì¢… ì–‘ì‹ ìƒì„± ë° ë³µì‚¬ ê¸°ëŠ¥ (í† ìŠ¤íŠ¸ ì•Œë¦¼ í¬í•¨)
        // -----------------------------------------------------------

        // 1. í† ìŠ¤íŠ¸ ì•Œë¦¼ ë©”ì‹œì§€ í•¨ìˆ˜ (í™”ë©´ í•˜ë‹¨ì— íŒì—…)
        function showToast(message, type = 'success') {
            let toast = document.getElementById('custom-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'custom-toast';
                toast.className = 'toast-container';
                document.body.appendChild(toast);
            }

            const icon = type === 'success' ? 'âœ…' : 'âš ï¸';
            toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 2. ë³µì‚¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        copyBtn.addEventListener('click', () => {
            const template = formTemplates[currentFormType];

            // ìŠ¤íƒ€ì¼ ì •ì˜
            const FONT = "font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; font-size: 10pt;";
            const TD_L = `padding: 8px; font-weight: bold; text-align: center; background-color: #f2f2f2; ${FONT}`;
            const TD_V = `padding: 8px; vertical-align: top; ${FONT}`;

            // í™”ë©´ì— ë³´ì´ëŠ” ìˆœì„œëŒ€ë¡œ ì—‘ì…€/ìœ„í•˜ê³ ì—ë„ ë¶™ì—¬ë„£ê¸° ìœ„í•´ ì •ë ¬ ìˆœì„œ ì •ì˜
            // (render í•¨ìˆ˜ì— ìˆëŠ” ìˆœì„œì™€ ë™ì¼í•˜ê²Œ ë§ì¶¤)
            const FIELD_ORDER = [
                'itemName',      // í’ˆëª©ëª…
                'unitPrice',     // ë‹¨ê°€
                'qty',           // ìˆ˜ëŸ‰
                'amount',        // ê¸ˆì•¡
                'date',          // ë‚ ì§œ
                'paymentTerms',  // ì§€ê¸‰ì¡°ê±´
                'user',          // ì‚¬ìš©ì
                'paymentMethod', // ê²°ì œìˆ˜ë‹¨
                'vendor',        // ê±°ë˜ì²˜
                'account',       // ê³„ì¢Œ
                'relatedTask',   // ê´€ë ¨ê³¼ì œ
                'purpose',       // ëª©ì 
                'note',          // ë¹„ê³ 

                // ê·¸ ì™¸ í•„ë“œë“¤ (ìš°ì„ ìˆœìœ„ ë‚®ìŒ)
                'service', 'course', 'license', 'tripObjective',
                'spec', 'periodFrom', 'periodTo',
                'isRecurring', 'recurringPeriod', 'recurringDate',
                'origin', 'destination', 'place', 'attendees', 'provider', 'manufacturer',
                'ipMgmtNo', 'invoiceNo', 'proof', 'seats'
            ];

            // í•„ë“œ ì •ë ¬ í•¨ìˆ˜
            const orderIndex = (id) => {
                const i = FIELD_ORDER.indexOf(id);
                // ì •ì˜ë˜ì§€ ì•Šì€ í•„ë“œëŠ” ë’¤ë¡œ ë³´ëƒ„
                return i === -1 ? 1000 + template.fields.findIndex(f => f.id === id) : i;
            };

            // ìˆ¨ê¹€ ì²˜ë¦¬ëœ í•„ë“œëŠ” ì œì™¸í•˜ê³ , ìœ„ ìˆœì„œëŒ€ë¡œ ì •ë ¬
            const allVisibleFields = template.fields.filter(field => !hiddenFields.includes(field.id));
            const fieldsToCopy = allVisibleFields.slice().sort((a, b) => orderIndex(a.id) - orderIndex(b.id));

            // [í—¤ë” ìƒì„±] ì œëª© + í•­ëª©1, í•­ëª©2...
            const headerCells = items.map((_, i) =>
                `<td style="text-align:center; font-weight:bold; background-color:#deebee; padding:8px; ${FONT}">í•­ëª© ${i + 1}</td>`
            ).join('');
            const headerRow = `<tr><td style="${TD_L}">${template.title}</td>${headerCells}</tr>`;

            // [ë³¸ë¬¸ ìƒì„±] ê° í•„ë“œë³„ë¡œ í–‰ì„ ìƒì„±
            const bodyRows = fieldsToCopy.map(field => {
                const valueCells = items.map(item => {
                    const value = item[field.id] || '';
                    // ì¤„ë°”ê¿ˆ ë¬¸ìë¥¼ <br>íƒœê·¸ë¡œ ë³€í™˜
                    return `<td style="${TD_V}">${String(value).replace(/\n/g, '<br>')}</td>`;
                }).join('');

                return `<tr><td style="${TD_L}">${field.label}</td>${valueCells}</tr>`;
            }).join('');

            // ìµœì¢… HTML í…Œì´ë¸” ì¡°í•©
            const finalHtml = `
                <table border="1" style="border-collapse: collapse; width: 100%; ${FONT}">
                    <thead>${headerRow}</thead>
                    <tbody>${bodyRows}</tbody>
                </table>
            `;

            // í´ë¦½ë³´ë“œì— ë³µì‚¬ ì‹¤í–‰
            try {
                // ìµœì‹  ë¸Œë¼ìš°ì € ë°©ì‹ (Clipboard API)
                const blob = new Blob([finalHtml], { type: 'text/html' });
                const clipboardItem = new ClipboardItem({ 'text/html': blob });

                navigator.clipboard.write([clipboardItem]).then(() => {
                    showToast("ë³µì‚¬ ì™„ë£Œ! WEHAGOì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.", "success");
                }).catch(err => {
                    console.error('Clipboard API Error:', err);
                    // ì‹¤íŒ¨ ì‹œ fallback (êµ¬í˜• ë°©ì‹)
                    fallbackCopy(finalHtml);
                });
            } catch (e) {
                console.error('Copy failed:', e);
                fallbackCopy(finalHtml);
            }

            // êµ¬í˜• ë¸Œë¼ìš°ì € í˜¸í™˜ìš© í•¨ìˆ˜
            function fallbackCopy(html) {
                const listener = (e) => {
                    e.clipboardData.setData("text/html", html);
                    e.clipboardData.setData("text/plain", html);
                    e.preventDefault();
                };
                document.addEventListener("copy", listener);
                document.execCommand("copy");
                document.removeEventListener("copy", listener);
                showToast("ë³µì‚¬ ì™„ë£Œ! (í˜¸í™˜ ëª¨ë“œ)", "success");
            }
        });




        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => { adjustContainerWidth(); }, 150);
        });

        // --- AI Integration Logic ---
        const settingsBtn = document.getElementById('settings-btn');
        const apiKeyModal = document.getElementById('api-key-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const apiKeyInput = document.getElementById('api-key-input');

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const runAnalysisBtn = document.getElementById('run-analysis-btn');
        const aiLoading = document.getElementById('ai-loading');
        const userInstructionInput = document.getElementById('user-instruction');

        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
        let stagedFiles = []; // (ì¤‘ìš”) íŒŒì¼ ì„ì‹œ ì €ì¥ì†Œ

        settingsBtn.addEventListener('click', () => {
            apiKeyInput.value = GEMINI_API_KEY;
            apiKeyModal.classList.add('active');
        });

        closeModalBtn.addEventListener('click', () => {
            apiKeyModal.classList.remove('active');
        });

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                GEMINI_API_KEY = key;
                localStorage.setItem('gemini_api_key', key);
                alert('API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                apiKeyModal.classList.remove('active');
            } else {
                alert('API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        });

        // --- File Drag & Drop and Selection ---
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) stageFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) stageFiles(e.target.files);
        });

        // [ì¶”ê°€] í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì‹œì—ë„ ë²„íŠ¼ í™œì„±í™” ì²´í¬
        userInstructionInput.addEventListener('input', () => {
            updateFileStatus();
        });

        // íŒŒì¼ì„ ë°”ë¡œ ë¶„ì„í•˜ì§€ ì•Šê³  ëŒ€ê¸°ì—´ì— ì¶”ê°€
        function stageFiles(files) {
            const newFiles = Array.from(files);
            stagedFiles = [...stagedFiles, ...newFiles];
            updateFileStatus();
        }

        // [ìˆ˜ì •] íŒŒì¼ or í…ìŠ¤íŠ¸ ì…ë ¥ ì—¬ë¶€ í™•ì¸í•˜ì—¬ ë²„íŠ¼ í™œì„±í™”
        function updateFileStatus() {
            const fileListBox = document.getElementById('file-list-box');
            const runBtn = document.getElementById('run-analysis-btn');
            const instructionText = userInstructionInput.value.trim();

            // íŒŒì¼ ëª©ë¡ ë Œë”ë§
            if (stagedFiles.length === 0) {
                fileListBox.innerHTML = `
                        <div style="text-align: center; color: rgba(255,255,255,0.6);">
                            ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>`;
                fileListBox.style.justifyContent = "center";
            } else {
                const listHtml = stagedFiles.map((f, idx) => `
                        <div class="file-item">
                            <span>ğŸ“„</span>
                            <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${f.name}</span>
                            <span style="font-size:0.8rem; opacity:0.7;">${(f.size / 1024).toFixed(1)}KB</span>
                            <span style="cursor:pointer;" onclick="removeStagedFile(${idx})">âœ–</span>
                        </div>
                    `).join('');

                fileListBox.innerHTML = listHtml;
                fileListBox.style.justifyContent = "flex-start";
            }

            // [ì¤‘ìš”] íŒŒì¼ì´ ìˆê±°ë‚˜ OR í”„ë¡¬í”„íŠ¸ì— ê¸€ìê°€ ìˆìœ¼ë©´ í™œì„±í™”
            if (stagedFiles.length > 0 || instructionText.length > 0) {
                const fileCountText = stagedFiles.length > 0 ? `${stagedFiles.length}ê°œ íŒŒì¼ ` : '';
                const textOnlyText = stagedFiles.length === 0 ? 'ì…ë ¥í•œ ì§€ì‹œì‚¬í•­ìœ¼ë¡œ ' : '';

                runBtn.innerHTML = `ğŸš€ ${fileCountText}${textOnlyText}ë¶„ì„ ì‹œì‘í•˜ê¸°`;
                runBtn.disabled = false;
                runBtn.style.opacity = "1";
                runBtn.style.cursor = "pointer";
            } else {
                runBtn.innerHTML = "ğŸš€ íŒŒì¼ ë˜ëŠ” ì§€ì‹œì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”";
                runBtn.disabled = true;
                runBtn.style.opacity = "0.6";
                runBtn.style.cursor = "not-allowed";
            }
        }

        function removeStagedFile(index) {
            stagedFiles.splice(index, 1);
            updateFileStatus();
            document.getElementById('file-input').value = '';
        }

        // ë¶„ì„ ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
        runAnalysisBtn.addEventListener('click', () => {
            // [ìˆ˜ì •] íŒŒì¼ì´ ì—†ì–´ë„ í…ìŠ¤íŠ¸ë§Œ ìˆìœ¼ë©´ ì‹¤í–‰ ê°€ëŠ¥
            const instructionText = userInstructionInput.value.trim();
            if (stagedFiles.length === 0 && instructionText === "") {
                showToast('ë¶„ì„í•  íŒŒì¼ì´ë‚˜ ì§€ì‹œì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            handleFilesAnalysis();
        });

        async function handleFilesAnalysis() {
            if (!GEMINI_API_KEY) {
                alert('ë¨¼ì € ì„¤ì •(âš™ï¸)ì—ì„œ Google API Keyë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                settingsBtn.click();
                return;
            }

            // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            aiLoading.style.display = 'flex';
            const loadingInterval = startLoadingAnimation();

            try {
                const processedData = {
                    images: [],
                    textContext: ""
                };

                for (const file of stagedFiles) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (file.type.startsWith('image/') || file.type === 'application/pdf') {
                        const base64 = await readFileAsBase64(file);
                        processedData.images.push({ mimeType: file.type, data: base64 });
                    } else if (['xlsx', 'xls', 'csv'].includes(ext)) {
                        const text = await readExcelFile(file);
                        processedData.textContext += `\n\n--- File: ${file.name} (Excel Data) ---\n${text}`;
                    } else if (['docx'].includes(ext)) {
                        const text = await readWordFile(file);
                        processedData.textContext += `\n\n--- File: ${file.name} (Word Document) ---\n${text}`;
                    } else if (['txt'].includes(ext) || file.type.startsWith('text/')) {
                        const text = await readFileAsText(file);
                        processedData.textContext += `\n\n--- File: ${file.name} (Text File) ---\n${text}`;
                    }
                }

                await analyzeMixedContent(processedData);
                showToast('ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.', 'success');

            } catch (error) {
                console.error("File Processing Error:", error);
                showToast(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            } finally {
                clearInterval(loadingInterval);
                aiLoading.style.display = 'none';
                stagedFiles = [];
                userInstructionInput.value = ''; // ì‹¤í–‰ í›„ ì…ë ¥ì°½ ë¹„ìš°ê¸°
                updateFileStatus();
                fileInput.value = '';
            }
        }

        // Helpers
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        let combinedText = "";
                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const csv = XLSX.utils.sheet_to_csv(worksheet);
                            combinedText += `[Sheet: ${sheetName}]\n${csv}\n`;
                        });
                        resolve(combinedText);
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        function readWordFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mammoth.extractRawText({ arrayBuffer: e.target.result })
                        .then(result => resolve(result.value))
                        .catch(reject);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // AI ë¶„ì„ í•¨ìˆ˜
        async function analyzeMixedContent({ images, textContext }) {
            try {
                const template = formTemplates[currentFormType];
                const fieldsInfo = template.fields.map(f => `- ${f.id} (${f.label})`).join('\n');
                const vendorListKeys = Object.keys(vendors).join(', ');
                const userInstruction = document.getElementById('user-instruction').value.trim();
                const mode = document.querySelector('input[name="aiMode"]:checked').value;
                let splitInstruction = "";

                if (mode === 'merge') {
                    splitInstruction = `[MODE: MERGE] Consolidate everything into ONE entry. Sum all amounts.`;
                } else {
                    const splitType = document.querySelector('input[name="splitType"]:checked').value;
                    if (splitType === 'auto') {
                        splitInstruction = `[MODE: AUTO-SPLIT] Logically separate entries (by invoice, vendor, or category). Return an Array.`;
                    } else {
                        const count = document.getElementById('manualCountInput').value;
                        splitInstruction = `[MODE: FIXED-COUNT SPLIT] Strictly create exactly ${count} entries. Return an Array of ${count} objects.`;
                    }
                }

                // [ìˆ˜ì •] ê²°ì œ ìˆ˜ë‹¨ ì˜µì…˜ ëª…ì‹œ
                const validPaymentMethods = paymentMethodOptions.join("', '");

                const promptText = `
                    You are an expert Tax & Accounting Assistant for 'Radexel Inc.'.
                    
                    [Goal]
                    Extract data to fill out the company approval form: "${template.title}".

                    [USER INSTRUCTION - HIGH PRIORITY]
                    The user has provided specific instructions. Follow these above all else:
                    "${userInstruction || "No specific instructions. Proceed with standard analysis."}"
                    
                    *If the user mentions 'Operating Account' or 'ìš´ì˜ë¹„', interpret it as 'ì´ì²´(ìš´ì˜ë¹„)'.
                    *If the user mentions 'Research Account' or 'ì—°êµ¬ë¹„', interpret it as 'ì—°êµ¬ë¹„ê³„ì¢Œì´ì²´'.
                    *If the user mentions 'Corporate Card', interpret it as 'ê°œì¸ë²•ì¸ì¹´ë“œ'.

                    ${splitInstruction}

                    [Context: Extracted Text]
                    ${textContext}

                    [Reference: Historical Data]
                    ${JSON.stringify(historicalDB)}

                    [Reference: Vendors]
                    [${vendorListKeys}] (Use exact names if matched)
                    
                    [Reference: Valid Payment Methods]
                    ['${validPaymentMethods}']
                    *Please try to select one of the above values for 'paymentMethod' if possible.

                    [Target Fields]
                    ${fieldsInfo}

                    [Rules]
                    1. **Format**: JSON Only. No markdown.
                    2. **Date**: 'YYYY. MM. DD.'
                    3. **Currency**: Remove symbols.
                    `;

                const parts = [{ text: promptText }];
                images.forEach(img => {
                    parts.push({ inline_data: { mime_type: img.mimeType, data: img.data } });
                });

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });

                const data = await response.json();

                if (data.error) throw new Error(`API ì˜¤ë¥˜: ${data.error.message}`);
                if (!data.candidates || !data.candidates[0]) throw new Error('AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');

                const textResponse = data.candidates[0].content.parts[0].text;
                const jsonStr = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();

                let result;
                try {
                    result = JSON.parse(jsonStr);
                } catch (e) {
                    console.error("JSON Parsing Failed", jsonStr);
                    throw new Error("AI ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                applyAIResult(result);

            } catch (error) {
                throw error;
            }
        }

        function applyAIResult(result) {
            let newItems = [];
            let firstResult = {};

            if (Array.isArray(result)) {
                newItems = result;
                firstResult = result[0] || {};
            } else {
                newItems = [result];
                firstResult = result;
            }

            // [ìˆ˜ì •] ë°ì´í„° ì •ì œ ë¡œì§ (Vendor, Payment, Currency Formatting)
            const refineItem = (res) => {
                // 1. Vendor Matching
                if (res.vendor) {
                    const aiVendor = res.vendor.replace(/\(ì£¼\)|ì£¼ì‹íšŒì‚¬|\s/g, '');
                    const bestMatch = Object.keys(vendors).find(k => {
                        const keyNorm = k.replace(/\(ì£¼\)|ì£¼ì‹íšŒì‚¬|\s/g, '');
                        return keyNorm.includes(aiVendor) || aiVendor.includes(keyNorm);
                    });
                    if (bestMatch) {
                        res.vendor = bestMatch;
                        if (!res.account && vendors[bestMatch].account) {
                            res.account = vendors[bestMatch].account;
                        }
                    }
                }

                // 2. Payment Method Matching
                if (res.paymentMethod) {
                    const pm = res.paymentMethod;
                    const bestPm = paymentMethodOptions.find(opt => opt.includes(pm) || pm.includes(opt));
                    if (bestPm) {
                        res.paymentMethod = bestPm;
                    } else {
                        if (pm.includes('ìš´ì˜')) res.paymentMethod = 'ì´ì²´(ìš´ì˜ë¹„)';
                        else if (pm.includes('ì—°êµ¬')) res.paymentMethod = 'ì—°êµ¬ë¹„ê³„ì¢Œì´ì²´';
                        else if (pm.includes('ì¹´ë“œ')) res.paymentMethod = 'ê°œì¸ë²•ì¸ì¹´ë“œ';
                        else if (pm.includes('KARA')) res.paymentMethod = 'ì´ì²´(KARA)';
                    }
                }

                // [ì¶”ê°€] AI ë¶„ì„ í›„ ê²°ì œìˆ˜ë‹¨ì— ë§ì¶° ê³¼ì œëª… ìë™ í• ë‹¹
                if (res.paymentMethod) {
                    if (res.paymentMethod.includes('KARA')) {
                        res.relatedTask = 'ë°©ì‚¬ì„  ìœµë³µí•© ì‚°ì—… ì§€ì›ì‚¬ì—…';
                    } else if (res.paymentMethod.includes('ë°ì´í„°')) {
                        res.relatedTask = 'ë°ì´í„° í™œìš© ì˜ë£Œ ê±´ê°• ì‚¬ì—…';
                    }
                }


                // [ê¸°ì¡´ ì½”ë“œ]
                // // 3. [ì‹ ê·œ] ê¸ˆì•¡ í•„ë“œ ì½¤ë§ˆ ìë™ ì ìš© (AIê°€ ê°€ì ¸ì˜¨ ê°’ í¬ë§·íŒ…)
                // if (res.amount) res.amount = formatSmartCurrency(res.amount);
                // 3. [ì‹ ê·œ] ê¸ˆì•¡ í•„ë“œ ì½¤ë§ˆ ìë™ ì ìš© (AIê°€ ê°€ì ¸ì˜¨ ê°’ í¬ë§·íŒ…)
                if (res.amount) res.amount = formatSmartCurrency(res.amount);
                if (res.unitPrice) res.unitPrice = formatSmartCurrency(res.unitPrice);

                return res;
            };

            // ì²« ë²ˆì§¸ ê²°ê³¼ ì •ì œ
            firstResult = refineItem(firstResult);

            pinnedFields.forEach(fieldId => {
                if (firstResult[fieldId]) {
                    commonData[fieldId] = firstResult[fieldId];
                    if (fieldId === 'vendor' && vendors[firstResult[fieldId]]) {
                        commonData['account'] = vendors[firstResult[fieldId]].account;
                    }
                }
            });

            items = newItems.map(res => {
                const refined = refineItem(res);
                const itemObj = {};
                Object.keys(refined).forEach(key => {
                    if (!pinnedFields.includes(key)) itemObj[key] = refined[key];
                });
                return itemObj;
            });

            if (items.length === 0) items.push({});

            render();

            setTimeout(() => {
                document.querySelectorAll('input, select').forEach(el => {
                    const id = el.id.replace('common_', '').split('_')[0];
                    if (firstResult[id]) {
                        el.classList.add('highlight');
                        setTimeout(() => el.classList.remove('highlight'), 2000);
                    }
                });
            }, 100);

            saveState();
        }

        function startLoadingAnimation() {
            const msgs = [
                "íŒŒì¼ ë‚´ìš©ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤... ğŸ“–",
                "AIê°€ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤... ğŸ”",
                "ì–‘ì‹ì— ë§ì¶° ë°ì´í„°ë¥¼ ì •ë¦¬ ì¤‘ì…ë‹ˆë‹¤... âœï¸",
                "ê±°ì˜ ë‹¤ ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš€"
            ];
            let idx = 0;
            const textEl = document.getElementById('loading-text');
            textEl.textContent = msgs[0];

            return setInterval(() => {
                idx = (idx + 1) % msgs.length;
                textEl.textContent = msgs[idx];
            }, 2000);
        }

        function formatSmartCurrency(value) {
            if (!value) return '';
            // 1. ê¸°ì¡´ ì½¤ë§ˆ ì œê±°
            let raw = value.toString().replace(/,/g, '');

            // 2. ìˆ«ìê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            // ì •ê·œì‹ ì„¤ëª…: \d+ (ìˆ«ì ì—°ì†) ë¶€ë¶„ì„ ì°¾ì•„ toLocaleStringìœ¼ë¡œ ë³€í™˜
            return raw.replace(/\d+/g, (num) => {
                return parseInt(num, 10).toLocaleString('en-US');
            });
        }


        // [ì¶”ê°€] ê³ ê¸‰ ì„¤ì • í† ê¸€ ì´ë²¤íŠ¸
        const toggleAdvBtn = document.getElementById('toggle-advanced-btn');
        const advOptions = document.getElementById('ai-advanced-options');
        toggleAdvBtn.addEventListener('click', () => {
            advOptions.classList.toggle('open');
            toggleAdvBtn.textContent = advOptions.classList.contains('open')
                ? "âš™ï¸ ê³ ê¸‰ ì„¤ì • ë‹«ê¸°"
                : "âš™ï¸ ê³ ê¸‰ ì„¤ì • (í•©ì‚°/ë¶„ë¦¬ ë°©ì‹)";
        });

        loadState();
        render();
        updateFileStatus(); // ì´ˆê¸°í™” í™•ì¸
    </script>


</body>

</html>
```




