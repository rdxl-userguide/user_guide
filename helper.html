<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WEHAGO 전자결재 폼 생성기</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #5a67d8; --primary-hover: #4c51bf; --border-color: #e2e8f0;
            --background-light: #f7fafc; --background-white: #ffffff; --text-dark: #2d3748;
            --text-light: #718096; --success-color: #38a169;
        }
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        /* --- 레이아웃 구조 --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Pretendard', sans-serif; background-color: var(--background-light);
            margin: 0; padding: 2rem;
            box-sizing: border-box;
        }
        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 2rem;
        }
        .fixed-width-container {
            width: 100%;
            max-width: 900px;
        }
        .expandable-width-container {
            width: 100%;
            max-width: 900px; /* JS에 의해 동적으로 변경됨 */
            transition: max-width 0.4s ease-in-out; /* 너비 변경 애니메이션 */
        }

        /* --- 공통 스타일 --- */
        h1 { font-size: 2rem; color: var(--text-dark); text-align: center; margin-bottom: 2.5rem; }
        .section { background: var(--background-white); padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        h2 { font-size: 1.25rem; color: var(--text-dark); margin-top: 0; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .label-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        label { font-weight: 500; font-size: 0.875rem; color: var(--text-light); }
        .label-icons { display: flex; align-items: center; }
        input, select { width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; box-sizing: border-box; font-family: inherit; transition: all 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.15); }
        input::placeholder { color: #cbd5e0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }

        /* --- 버튼 & 아이콘 --- */
        .button { display: inline-block; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; color: white; background-color: var(--primary-color); border: none; border-radius: 0.5rem; cursor: pointer; text-align: center; transition: background-color 0.2s; }
        .button:hover { background-color: var(--primary-hover); }
        .button-secondary { background-color: #edf2f7; color: var(--text-dark); }
        .button-secondary:hover { background-color: #e2e8f0; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0 0 0 0.5rem; line-height: 1; opacity: 0.3; transition: opacity 0.2s; }
        .icon-btn:hover { opacity: 1; }
        .hide-btn { font-size: 1.2rem; font-weight: bold; }

        /* --- 숨김/복원 기능 --- */
        .restore-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border-color); }
        .restore-section h4 { margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-light); font-weight: 500; }
        .restore-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .restore-btn { background-color: #edf2f7; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.25rem 0.75rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .restore-btn:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* --- 항목(Item) 카드 --- */
        #items-container-wrapper { width: 100%; overflow-x: auto; margin-top: 1.5rem; }
        #items-container { display: flex; gap: 1.5rem; padding-bottom: 1rem; }
        .item-card { background-color: var(--background-light); border: 1px solid #e2e8f0; padding: 1.5rem; border-radius: 0.5rem; transition: opacity 0.3s, transform 0.3s; flex: 0 0 320px; }
        .item-card.single-item { flex: 1 1 auto; }
        .item-fields-container > div { margin-bottom: 1.25rem; }
        .item-fields-container > div:last-child { margin-bottom: 0; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .item-header h3 { margin: 0; font-size: 1.1rem; }
        .remove-item-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); line-height: 1; }

        /* --- UX 개선 --- */
        #copyFeedback { text-align: center; color: var(--primary-color); font-weight: 600; margin-top: 1rem; opacity: 0; transition: opacity 0.5s; height: 24px;}
        .highlight { transition: box-shadow 0.1s; box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.4); }
        .header-controls { display:flex; justify-content:space-between; align-items:center; }

        /* --- 버전 정보 --- */
        .version-info {
            text-align: center;
            margin-top: 3rem;
            color: var(--text-light);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="fixed-width-container">
        <h1>WEHAGO 전자결재 폼 생성기 💡</h1>
        <div class="section" style="margin-bottom: 2rem;">
            <div class="header-controls">
                <h2>0. 양식 종류 선택</h2>
                <button id="reset-btn" class="button button-secondary" style="padding: 0.5rem 1rem;">[↻] 새로 작성</button>
            </div>
            <select id="masterFormType" class="button" style="width:100%; text-align:left; margin-top: 1rem;">
                <option value="general_expense">지출품의서 - 일반</option>
                <option value="meeting_expense">지출품의서 - 사내 사외 회의비</option>
                <option value="outsourcing_expense">지출품의서 - 외주용역</option>
                <option value="education_expense">지출품의서 - 교육비</option>
                <option value="software_expense">지출품의서 - 소프트웨어</option>
                <option value="ip_expense">지출품의서 - 지식재산권</option>
                <option value="travel_expense_claim">지출승인요청서 - 교통여비 청구</option>
                <option value="business_trip_report">출장품의서 - 지출정보</option>
            </select>
        </div>
        <div class="section">
            <div class="header-controls">
                <h2>1. 공통 정보 입력</h2>
            </div>
            <div class="grid" id="common-inputs-container"></div>
            <div id="common-restore-section" class="restore-section" style="display: none;"></div>
            <button id="apply-common-btn" class="button" style="margin-top: 1rem;">[↓] 모든 항목에 공통 정보 적용</button>
        </div>
    </div>

    <div class="expandable-width-container">
        <div class="section">
            <div class="header-controls">
                <h2>2. 세부 항목 입력</h2>
                <button id="add-item-btn" class="button button-secondary">[+] 항목 추가</button>
            </div>
            <div id="items-container-wrapper">
                <div id="items-container"></div>
            </div>
            <div id="item-restore-section" class="restore-section" style="display: none;"></div>
        </div>
    </div>

    <div class="fixed-width-container">
        <button id="copyBtn" class="button" style="width:100%; padding: 1rem; font-size: 1.2rem;">🚀 최종 양식 생성 및 복사</button>
        <div id="copyFeedback">✅ 복사 완료! WEHAGO에 붙여넣으세요.</div>
    </div>
</div>

<div class="version-info">
    Version 2.0 (2025.10.01)
</div>

<script>
    const vendors = {
        '특허법인 비엘티': { paymentMethod: '운영계좌 이체', account: '우리은행 / 1005303954125 / 예금주 : 특허법인 비엘티' },
        '메트로실리콘': { paymentMethod: '운영계좌이체', account: '국민은행 / 465701-04-054612 / 예금주 : 메트로실리콘' },
        '특허법인 OO': { paymentMethod: '운영계좌이체', account: '국민은행 / 401234-74-786355 / 예금주 : 특허법인 OO' },
        'OO캠퍼스': { paymentMethod: '운영계좌이체', account: '국민은행 / 504401-45-404568 / 예금주 : OO캠퍼스' },
    };

    const BASE_COMMON_FIELDS = [
        { id: 'vendor', label: '거래처/구입처/용역업체', example: '네이버페이, 지오비전 등' },
        { id: 'paymentMethod', label: '결제수단', example: '운영계좌이체, 개인법인카드 등' },
        { id: 'account', label: '입금계좌', example: '국민은행 / 465701-04-054612 / 예금주 : OOO' },
        { id: 'purpose', label: '지출/구매/용역 목적 및 필요성', example: '구매를 요청하는 이유 · 필요성' },
    ];

    const FIELD = {
        itemName: { id: 'itemName', label: '품목명/지출명', example: '업무용 모니터, 시뮬레이션용 서버' },
        spec: { id: 'spec', label: '규격/설명/용역내용/지출내용', example: '간략한 세부 내용' },
        qty: { id: 'qty', label: '수량', example: '2, 4' },
        unitPrice: { id: 'unitPrice', label: '단가(원)', example: '22,000,000 원 / 10 USD' },
        amount: { id: 'amount', label: '총 금액(부가세 포함)', example: '44,000,000 원 / 40 USD' },
        date: { id: 'date', label: '구매/지출일자', example: '2024. 6. 18.' },
        note: { id: 'note', label: '기타사항', example: '특별 요청사항 또는 부가 정보' },
        user: { id: 'user', label: '사용자/신청자', example: '사용할 임직원, 부서, 공용 등' },
        manufacturer: { id: 'manufacturer', label: '제조사', example: '한성컴퓨터, MS, 출판사 등' },
        isRecurring: { id: 'isRecurring', label: '정기결제 여부', example: '일시납 / 매년 / 매월 등' },
        recurringPeriod: { id: 'recurringPeriod', label: '자동 결제 기간', example: '무기한, 2023.3.14 ~ 2024.3.14' },
        recurringDate: { id: 'recurringDate', label: '자동 결제일', example: '매달 10일, 매년 3월 둘째 주 등' },
        paymentTerms: { id: 'paymentTerms', label: '지급 조건', example: '계약금: 계약 후 7일 이내 총 금액의 30% 지급' },
        place: { id: 'place', label: '장소/교육장소', example: '온라인, 라덱셀 회의실 등' },
        attendees: { id: 'attendees', label: '참석자/교육대상', example: '대상 직원, 부서, 전 임직원 등' },
        service: { id: 'service', label: '용역명', example: '소프트웨어 개발 외주 용역' },
        periodFrom: { id: 'periodFrom', label: '기간(시작)', example: '2024. 6. 18.' },
        periodTo: { id: 'periodTo', label: '기간(종료)', example: '2024. 7. 18.' },
        course: { id: 'course', label: '교육명칭', example: '데이터분석 실무 강의' },
        provider: { id: 'provider', label: '강사/교육기관', example: '홍길동/패스트캠퍼스' },
        relatedTask: { id: 'relatedTask', label: '관련 업무', example: 'OOO 프로젝트' },
        license: { id: 'license', label: '제품/라이선스명', example: '미로보드 비즈니스 플랜' },
        seats: { id: 'seats', label: '라이선스 수', example: '2, 4' },
        origin: { id: 'origin', label: '출발지', example: '회사' },
        destination:{ id: 'destination',label: '도착지', example: '강원대병원' },
        tripObjective:{id: 'tripObjective',label:'출장 목적', example: '의료기기 설치' },
        proof: { id: 'proof', label: '증빙자료', example: '네이버 길찾기 캡처 첨부' },
        expenseTransit:{ id:'expenseTransit',label:'교통비', example: '항공료, 기차료 등 총 금액' },
        expenseLodging:{id:'expenseLodging',label:'숙박비', example: '숙박비 총 금액' },
        expenseMeal:{id:'expenseMeal',label:'식비', example: '업무 관련 식사 비용' },
        expenseOther:{id:'expenseOther',label:'기타비용', example: '기타 비용 총 금액' },
        ipMgmtNo: { id: 'ipMgmtNo', label: '특허 관리번호', example: 'BPP2021-0030US' },
        invoiceNo: { id: 'invoiceNo', label: '청구서 번호', example: 'SPS24-2336' },
    };

    const T = (title, ...fields) => ({ title, fields: [...BASE_COMMON_FIELDS, ...Object.values(FIELD).filter(f => fields.includes(f))] });

    const formTemplates = {
        'general_expense': T('지출품의서 - 일반', FIELD.itemName, FIELD.unitPrice, FIELD.qty, FIELD.manufacturer, FIELD.amount, FIELD.isRecurring, FIELD.recurringPeriod, FIELD.recurringDate, FIELD.date, FIELD.paymentTerms, FIELD.user, FIELD.note),
        'meeting_expense': T('지출품의서 - 사내 사외 회의비', FIELD.itemName, FIELD.amount, FIELD.user, FIELD.note),
        'outsourcing_expense': T('지출품의서 - 외주용역', FIELD.service, FIELD.periodFrom, FIELD.periodTo, FIELD.spec, FIELD.user, FIELD.amount, FIELD.isRecurring, FIELD.recurringPeriod, FIELD.recurringDate, FIELD.paymentTerms, FIELD.note),
        'education_expense': T('지출품의서 - 교육비', FIELD.course, FIELD.provider, FIELD.periodFrom, FIELD.periodTo, FIELD.place, FIELD.attendees, FIELD.amount, FIELD.relatedTask, FIELD.note),
        'software_expense': T('지출품의서 - 소프트웨어', FIELD.license, FIELD.unitPrice, FIELD.seats, FIELD.manufacturer, FIELD.amount, FIELD.isRecurring, FIELD.recurringPeriod, FIELD.recurringDate, FIELD.date, FIELD.paymentTerms, FIELD.user, FIELD.note),
        'ip_expense': T('지출품의서 - 지식재산권', FIELD.spec, FIELD.ipMgmtNo, FIELD.invoiceNo, FIELD.amount, FIELD.paymentTerms, FIELD.note),
        'travel_expense_claim': T('지출승인요청서 - 교통여비 청구', FIELD.date, FIELD.origin, FIELD.destination, FIELD.tripObjective, FIELD.amount, FIELD.proof),
        'business_trip_report': T('출장품의서 - 지출정보', FIELD.tripObjective, FIELD.place, FIELD.expenseTransit, FIELD.expenseLodging, FIELD.expenseMeal, FIELD.expenseOther, FIELD.amount, FIELD.note),
    };

    let items = [{}];
    let currentFormType = 'general_expense';
    let pinnedFields = [];
    let hiddenFields = [];

    const expandableContainer = document.querySelector('.expandable-width-container');
    const commonInputsContainer = document.getElementById('common-inputs-container');
    const itemsContainer = document.getElementById('items-container');
    const addItemBtn = document.getElementById('add-item-btn');
    const applyCommonBtn = document.getElementById('apply-common-btn');
    const copyBtn = document.getElementById('copyBtn');
    const formTypeSelector = document.getElementById('masterFormType');
    const resetBtn = document.getElementById('reset-btn');

    const saveState = () => localStorage.setItem('wehagoFormData', JSON.stringify({ items, currentFormType, pinnedFields, hiddenFields }));
    const loadState = () => {
        try {
            const savedState = localStorage.getItem('wehagoFormData');
            if (savedState) {
                const data = JSON.parse(savedState);
                items = data.items && data.items.length > 0 ? data.items : [{}];
                currentFormType = data.currentFormType || 'general_expense';
                pinnedFields = data.pinnedFields || [];
                hiddenFields = data.hiddenFields || [];
                formTypeSelector.value = currentFormType;
            }
        } catch (e) { console.error("Could not load state", e); }
    };

    const adjustContainerWidth = () => {
        const section = expandableContainer.querySelector('.section');
        const bodyPadding = parseFloat(getComputedStyle(document.body).paddingLeft) * 2;
        const sectionPadding = parseFloat(getComputedStyle(section).paddingLeft) * 2;
        const maxAllowedWidth = window.innerWidth - bodyPadding;
        const cardWidth = 320;
        const cardGap = 1.5 * 16;
        const defaultWidth = 900;
        let requiredContainerWidth = (items.length <= 1) ? defaultWidth : ((items.length + 1) * cardWidth) + (items.length * cardGap) + sectionPadding;
        const finalContainerWidth = Math.min(requiredContainerWidth, maxAllowedWidth);
        expandableContainer.style.maxWidth = `${Math.max(finalContainerWidth, defaultWidth)}px`;
        const actualContentWidth = (items.length * cardWidth) + (Math.max(0, items.length - 1) * cardGap);
        itemsContainer.style.width = items.length > 1 ? `${actualContentWidth}px` : '100%';
    };

    function render() {
        const template = formTemplates[currentFormType];
        const baseCommonIds = BASE_COMMON_FIELDS.map(f => f.id);

        const allCommonFields = template.fields.filter(f => baseCommonIds.includes(f.id) || pinnedFields.includes(f.id));
        const allItemFields = template.fields.filter(f => !baseCommonIds.includes(f.id) && !pinnedFields.includes(f.id));

        const visibleCommonFields = allCommonFields.filter(f => !hiddenFields.includes(f.id));
        const visibleItemFields = allItemFields.filter(f => !hiddenFields.includes(f.id));

        const hiddenCommonFields = allCommonFields.filter(f => hiddenFields.includes(f.id));
        const hiddenItemFields = allItemFields.filter(f => hiddenFields.includes(f.id));

        commonInputsContainer.innerHTML = visibleCommonFields.map(field => {
            const isPinned = pinnedFields.includes(field.id);
            const pinButton = isPinned ? `<button class="icon-btn" data-field-id="${field.id}" title="세부 항목으로 되돌리기">📌</button>` : '';
            let inputHtml = `<div><div class="label-wrapper"><label for="common_${field.id}">${field.label}</label><div class="label-icons">${pinButton}<button class="icon-btn hide-btn" data-field-id="${field.id}" title="항목 숨기기">×</button></div></div>`;
            if (field.id === 'vendor') {
                inputHtml += `<select id="common_${field.id}"><option value="">-- 직접 입력 --</option>${Object.keys(vendors).map(k => `<option value="${k}">${k}</option>`).join('')}</select>`;
            } else {
                inputHtml += `<input type="text" id="common_${field.id}" placeholder="${field.example || ''}">`;
            }
            return inputHtml + `</div>`;
        }).join('');

        renderRestoreSection('common-restore-section', hiddenCommonFields);

        itemsContainer.innerHTML = items.map((itemData, index) => {
            return `
                <div class="item-card" data-index="${index}">
                    <div class="item-header"><h3>항목 ${index + 1}</h3>${items.length > 1 ? '<button class="remove-item-btn" title="항목 삭제">×</button>' : ''}</div>
                    <div class="item-fields-container">${visibleItemFields.map(field => `
                        <div>
                            <div class="label-wrapper">
                                <label for="${field.id}_${index}">${field.label}</label>
                                <div class="label-icons">
                                    <button class="icon-btn" data-field-id="${field.id}" title="공통 항목으로 고정">📌</button>
                                    <button class="icon-btn hide-btn" data-field-id="${field.id}" title="항목 숨기기">×</button>
                                </div>
                            </div>
                            <input type="text" id="${field.id}_${index}" value="${itemData[field.id] || ''}" placeholder="${field.example || ''}">
                        </div>`
                    ).join('')}</div>
                </div>`;
        }).join('');

        renderRestoreSection('item-restore-section', hiddenItemFields);

        if (items.length === 1) itemsContainer.querySelector('.item-card')?.classList.add('single-item');
        adjustContainerWidth();
        saveState();
    }

    function renderRestoreSection(sectionId, hiddenFields) {
        const sectionEl = document.getElementById(sectionId);
        if (hiddenFields.length > 0) {
            sectionEl.style.display = 'block';
            sectionEl.innerHTML = `
                <h4>[+] 복원할 항목을 클릭하세요</h4>
                <div class="restore-list">${hiddenFields.map(f => `<button class="restore-btn" data-field-id="${f.id}">${f.label}</button>`).join('')}</div>`;
        } else {
            sectionEl.style.display = 'none';
            sectionEl.innerHTML = '';
        }
    }

    function handleIconClick(e) {
        const btn = e.target.closest('.icon-btn');
        if (!btn) return;

        const fieldId = btn.dataset.fieldId;

        // This is a simplified check. A more robust way is to check classList.
        if (btn.title.includes('고정')) { // Pinning
            const index = pinnedFields.indexOf(fieldId);
            if (index > -1) {
                // This logic is flawed, unpinning should happen in common section
            } else {
                pinnedFields.push(fieldId);
            }
        } else if (btn.title.includes('되돌리기')) { // Unpinning
             const index = pinnedFields.indexOf(fieldId);
             if (index > -1) pinnedFields.splice(index, 1);
        } else if (btn.classList.contains('hide-btn')) {
            if (!hiddenFields.includes(fieldId)) {
                hiddenFields.push(fieldId);
            }
        }
        render();
    }

    function handleRestoreClick(e) {
        const restoreBtn = e.target.closest('.restore-btn');
        if (restoreBtn) {
            const fieldId = restoreBtn.dataset.fieldId;
            const index = hiddenFields.indexOf(fieldId);
            if(index > -1) {
                hiddenFields.splice(index, 1);
                render();
            }
        }
    }

    // A more robust icon handler
    function masterIconHandler(e) {
        const btn = e.target.closest('.icon-btn');
        if(!btn) return;
        const fieldId = btn.dataset.fieldId;

        if(btn.title.includes('고정') || btn.title.includes('되돌리기')) {
            const index = pinnedFields.indexOf(fieldId);
            if (index > -1) pinnedFields.splice(index, 1); // unpin
            else pinnedFields.push(fieldId); // pin
        } else if (btn.classList.contains('hide-btn')) {
            if (!hiddenFields.includes(fieldId)) hiddenFields.push(fieldId);
        }
        render();
    }

    document.getElementById('common-restore-section').addEventListener('click', handleRestoreClick);
    document.getElementById('item-restore-section').addEventListener('click', handleRestoreClick);
    commonInputsContainer.addEventListener('click', masterIconHandler);
    itemsContainer.addEventListener('click', (e) => {
        if(e.target.closest('.icon-btn')) masterIconHandler(e);
        if (e.target.classList.contains('remove-item-btn')) {
            items.splice(e.target.closest('.item-card').dataset.index, 1);
            if (items.length === 0) items.push({});
            render();
        }
    });

    applyCommonBtn.addEventListener('click', () => {
        const commonData = {};
        const commonFieldIds = [...BASE_COMMON_FIELDS.map(f => f.id), ...pinnedFields];

        commonFieldIds.forEach(fieldId => {
             const el = document.getElementById(`common_${fieldId}`);
             if (el) commonData[fieldId] = el.value;
        });

        items.forEach((item, index) => {
            Object.assign(item, commonData);
        });

        document.querySelectorAll('#common-inputs-container input, #common-inputs-container select').forEach(el => {
            el.classList.add('highlight');
            setTimeout(() => el.classList.remove('highlight'), 1200);
        });
        saveState();
    });

    addItemBtn.addEventListener('click', () => {
        items.push({});
        render();
        const newCard = itemsContainer.lastElementChild;
        if (newCard) {
            newCard.querySelector('input')?.focus();
            newCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    });

    itemsContainer.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT') {
            const index = e.target.closest('.item-card').dataset.index;
            const fieldId = e.target.id.split('_')[0];
            items[index][fieldId] = e.target.value;
            saveState();
        }
    });

    formTypeSelector.addEventListener('change', (e) => {
        if (confirm('양식을 변경하면 현재 작성된 항목과 모든 설정(핀, 숨김)이 초기화됩니다. 계속하시겠습니까?')) {
            currentFormType = e.target.value;
            items = [{}];
            pinnedFields = [];
            hiddenFields = [];
            render();
        } else {
            e.target.value = currentFormType;
        }
    });

    resetBtn.addEventListener('click', () => {
        if (confirm('정말로 모든 항목과 설정(핀, 숨김)을 지우고 새로 작성하시겠습니까?')) {
            items = [{}];
            pinnedFields = [];
            hiddenFields = [];
            localStorage.removeItem('wehagoFormData');
            render();
            document.querySelectorAll('#common-inputs-container input, #common-inputs-container select').forEach(el => el.value = '');
        }
    });

    document.getElementById('common-inputs-container').addEventListener('change', e => {
        if (e.target.id === 'common_vendor') {
            const vendor = vendors[e.target.value];
            if (vendor) {
                const pmEl = document.getElementById('common_paymentMethod');
                const accEl = document.getElementById('common_account');
                if (pmEl) pmEl.value = vendor.paymentMethod || '';
                if (accEl) accEl.value = vendor.account || '';
            }
        }
    });

    copyBtn.addEventListener('click', () => {
        const template = formTemplates[currentFormType];
        const FONT = "font-family: 'Malgun Gothic', '맑은 고딕', sans-serif; font-size: 10pt;";
        const TD_L = `padding: 8px; font-weight: bold; text-align: center; background-color: #f2f2f2; ${FONT}`;
        const TD_V = `padding: 8px; vertical-align: top; ${FONT}`;
        const header = `<tr><td style="${TD_L}">${template.title}</td>${items.map((_, i) => `<td style="text-align:center; font-weight:bold; background-color:#deebee; padding:8px; ${FONT}">항목 ${i+1}</td>`).join('')}</tr>`;

        const commonData = {};
        const commonFieldIds = [...BASE_COMMON_FIELDS.map(f => f.id), ...pinnedFields];
        commonFieldIds.forEach(fieldId => {
             const el = document.getElementById(`common_${fieldId}`);
             if (el) commonData[fieldId] = el.value;
        });

        const bodyRows = template.fields.map(field => {
            const isCommonField = commonFieldIds.includes(field.id);
            return `<tr><td style="${TD_L}">${field.label}</td>${items.map(item => {
                const value = isCommonField ? (commonData[field.id] || '') : (item[field.id] || '');
                return `<td style="${TD_V}">${(value || '').replace(/\n/g, '<br>')}</td>`;
            }).join('')}</tr>`;
        });

        const finalHtml = `<table border="1" style="border-collapse: collapse; width: 100%; ${FONT}"><thead>${header}</thead><tbody>${bodyRows}</tbody></table>`;
        try {
            navigator.clipboard.write([new ClipboardItem({ 'text/html': new Blob([finalHtml], { type: 'text/html' }) })]);
            const fb = document.getElementById('copyFeedback');
            fb.style.opacity = '1';
            setTimeout(() => { fb.style.opacity = '0'; }, 2000);
        } catch(e) {
            console.error(e);
            alert('복사에 실패했습니다. 브라우저 콘솔을 확인해주세요.');
        }
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => { adjustContainerWidth(); }, 150);
    });

    loadState();
    render();
</script>
</body>
</html>

